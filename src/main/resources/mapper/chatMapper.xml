<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.sist.chat.ChatRoomMapper">

    <!-- 특정 부서와 권한을 모두 가진 관리자 한 명 조회 -->
    <select id="selectOneStaffByDeptAndPermission" resultType="String">
        SELECT staff_id FROM staff
        WHERE dept_iden = #{dept_iden}
        AND staff_id IN (
            SELECT staff_id FROM staff_permission WHERE permission_id_code LIKE CONCAT('%', #{permission_id_code}, '%')
        )
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- 유저, 관리자, 문의유형으로 채팅방 조회 -->
    <select id="findByUserAndStaffAndType" resultType="kr.co.sist.chat.ChatRoomDTO">
        SELECT * FROM chat_room
        WHERE user_num = #{user_num}
        AND staff_id = #{staff_id}
        AND chat_type = #{chat_type}
        FETCH FIRST 1 ROWS ONLY
    </select>

    <!-- room_id로 채팅방 조회 -->
    <select id="findByRoomId" resultType="kr.co.sist.chat.ChatRoomDTO">
        SELECT * FROM chat_room WHERE room_id = #{room_id}
    </select>

    <!-- 채팅방 생성: room_id에 시퀀스 사용 -->
    <insert id="insert" parameterType="kr.co.sist.chat.ChatRoomDTO">
        INSERT INTO chat_room (room_id, user_num, staff_id, dept_iden, chat_type)
        VALUES (FINAL.SEQ_CHAT_ROOM.NEXTVAL, #{user_num}, #{staff_id}, #{dept_iden}, #{chat_type})
    </insert>

    <!-- staff_id로 담당 채팅방 리스트 조회 -->
    <select id="findRoomsByStaffId" resultType="kr.co.sist.chat.ChatRoomDTO">
        SELECT * FROM chat_room WHERE staff_id = #{staff_id}
    </select>

    <!-- user_num으로 사용자의 채팅방 리스트 조회 -->
    <select id="findRoomsByUserId" resultType="kr.co.sist.chat.ChatRoomDTO">
        SELECT * FROM chat_room WHERE user_num = #{user_num} ORDER BY room_id ASC
    </select>

</mapper> 