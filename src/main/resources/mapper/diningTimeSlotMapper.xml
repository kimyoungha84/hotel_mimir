<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.sist.diningslot.DiningTimeSlotMapper">

<select id="selectTotalSeat" resultType="int">
  SELECT TOTAL_SEAT
  FROM DINING_TIME_SLOT
  WHERE DINING_ID = #{diningId}
    AND TO_CHAR(RESERVATION_TIME, 'YYYY-MM-DD HH24:MI') = TO_CHAR(#{reservationTime}, 'YYYY-MM-DD HH24:MI')
</select>

<!-- 예약된 인원 수 조회 -->
<select id="selectReservedCount" resultType="int">
  SELECT NVL(RESERVED_COUNT, 0)
  FROM DINING_TIME_SLOT
  WHERE DINING_ID = #{diningId}
    AND TO_CHAR(RESERVATION_TIME, 'YYYY-MM-DD HH24:MI') = TO_CHAR(#{reservationTime}, 'YYYY-MM-DD HH24:MI')
</select>
<!-- reservationDate 제거 -> Time에 날짜정보가 포함되어 있으므로 두 조건 간의 충돌 발생 -->

  <!-- 슬롯 존재 여부 확인 -->
  <select id="existsSlot" resultType="int">
    SELECT COUNT(*)
    FROM DINING_TIME_SLOT
    WHERE DINING_ID = #{diningId}
      AND RESERVATION_DATE = #{reservationDate}
      AND RESERVATION_TIME = #{reservationTime}
  </select>

  <!-- 슬롯 삽입 -->
  <insert id="insertSlot">
    INSERT INTO DINING_TIME_SLOT (
      SLOT_ID,
      DINING_ID,
      RESERVATION_DATE,
      RESERVATION_TIME,
      RESERVED_COUNT,
      TOTAL_SEAT
    ) VALUES (
      DINING_SLOT_SEQ.NEXTVAL,
      #{diningId},
      #{reservationDate},
      #{reservationTime},
      #{reservedCount},
      #{totalSeat}
    )
  </insert>

  <!-- 슬롯 업데이트 (좌석 수 증가) -->
  <update id="updateSlot">
    UPDATE DINING_TIME_SLOT
    SET RESERVED_COUNT = RESERVED_COUNT + #{reservedCount}
    WHERE DINING_ID = #{diningId}
      AND RESERVATION_DATE = #{reservationDate}
      AND RESERVATION_TIME = #{reservationTime}
  </update>
  
<select id="selectAllSlots" resultType="kr.co.sist.diningslot.DiningTimeSlotDTO">
  SELECT 
    SLOT_ID AS slotId,
    DINING_ID AS diningId,
    RESERVATION_DATE AS reservationDate,
    RESERVATION_TIME AS reservationTime,
    RESERVED_COUNT AS reservedCount,
    TOTAL_SEAT AS totalSeat
  FROM DINING_TIME_SLOT
  ORDER BY RESERVATION_DATE, RESERVATION_TIME
</select>

<update id="updateTotalSeat">
  UPDATE DINING_TIME_SLOT
  SET RESERVED_COUNT = #{reservedCount}
  WHERE SLOT_ID = #{slotId}
</update>

</mapper>