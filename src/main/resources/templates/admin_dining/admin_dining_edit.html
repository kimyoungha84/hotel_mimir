<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<title>ë‹¤ì´ë‹ ì •ë³´ ìˆ˜ì •</title>
<link rel="stylesheet" href="/admin_common_assets/css/common.css">

<!-- jQuery ì¶”ê°€ -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

<style>
  .edit-form-label { display: block; margin-top: 24px; font-weight: bold; margin-bottom: 15px; }
  .edit-form-input, .edit-form-textarea, .edit-form-select { width: 100%; padding: 8px; margin-top: 4px; border-radius: 5px; }
  .edit-form-img-preview { max-width: 200px; margin-top: 8px; display: block; }
  .edit-form-img-list { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px; }
  .edit-form-img-list img { max-width: 120px; border: 1px solid #ccc; border-radius: 4px; }
  .edit-form-section { margin-bottom: 32px; width: 50%; }
  .edit-form-btn-area { margin-top: 32px; display: flex; gap: 16px; }
  .modern-btn, .list-btn {
    background: linear-gradient(90deg, #856956 0%, #a88d7b 100%);
    color: #fff;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(133, 105, 86, 0.08);
    transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
    margin: 0 8px;
    letter-spacing: 0.5px;
  }
  .modern-btn:hover, .list-btn:hover {
    background: linear-gradient(90deg, #6d5747 0%, #856956 100%);
    box-shadow: 0 4px 16px rgba(133, 105, 86, 0.15);
    transform: translateY(-2px) scale(1.03);
  }
  .dining-section {
    margin-top : 50px;
  }
  
  /* íŒŒì¼ ì„ íƒ ì˜ì—­ êµ¬ë¶„ ìŠ¤íƒ€ì¼ */
  .file-upload-section {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    transition: border-color 0.3s ease;
  }
  .file-upload-section:hover {
    border-color: #856956;
  }
  
  /* í¼ ë°ì´í„° ì„¹ì…˜ ìŠ¤íƒ€ì¼ (ì´ë¯¸ì§€ ì—…ë¡œë“œì™€ êµ¬ë¶„) */
  .form-data-section {
    background: #f0f8ff;
    border: 2px dashed #e3f2fd;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    transition: border-color 0.3s ease;
  }
  .form-data-section:hover {
    border-color: #2196f3;
  }
  
  .file-upload-title {
    font-size: 18px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .file-upload-title::before {
    content: "ğŸ“";
    font-size: 20px;
  }
  
  /* í¼ ë°ì´í„° ì œëª© ìŠ¤íƒ€ì¼ */
  .form-data-title {
    font-size: 18px;
    font-weight: 600;
    color: #000000;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .form-data-title::before {
    content: "ğŸ“";
    font-size: 20px;
  }
  
  /* ëª¨ë˜í•œ ì‚­ì œ/êµì²´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .action-btn {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-right: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .action-btn:hover {
    background: linear-gradient(135deg, #495057 0%, #343a40 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .delete-btn {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  }
  .delete-btn:hover {
    background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
  }
  .replace-btn {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
  }
  .replace-btn:hover {
    background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
  }
  
  /* íŒŒì¼ ì…ë ¥ ìŠ¤íƒ€ì¼ ê°œì„  */
  .file-input-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
  }
  .file-input-wrapper input[type="file"] {
    width: 100%;
    padding: 10px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    background: white;
    transition: border-color 0.3s ease;
  }
  .file-input-wrapper input[type="file"]:hover {
    border-color: #856956;
  }
  .file-input-wrapper input[type="file"]:focus {
    outline: none;
    border-color: #856956;
    box-shadow: 0 0 0 3px rgba(133, 105, 86, 0.1);
  }
</style>
</head>
<body>
<th:block th:replace="~{administrator/fragments/admin_header :: admin_header}"></th:block>
<th:block th:replace="~{administrator/fragments/admin_sidebar :: admin_sidebar}"></th:block>
<div class="body-pd">
  <main class="main-content">
    <section class="dining-section">
      <h1>ë‹¤ì´ë‹ ì •ë³´ ìˆ˜ì •</h1>
      
      <!-- ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
      <div th:if="${message}" class="message-area" style="margin-bottom: 20px; padding: 10px; background-color: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px;">
        <span th:text="${message == 'dataUpdated' ? 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 
                        message == 'filesUpdated' ? 'íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.' : message}"></span>
      </div>

      <!-- ì¼ë°˜ ë°ì´í„° í¼ -->
      <form id="diningDataForm" th:action="@{/admin/dining/edit}" method="post">
        <input type="hidden" name="dining_id" th:value="${dining.dining_id}" />

        <div class="form-data-section">
          <div class="form-data-title">ê¸°ë³¸ ì •ë³´</div>
          <div class="edit-form-section">
            <label class="edit-form-label">ì´ë¦„</label>
            <input class="edit-form-input" type="text" name="dining_name" th:value="${dining.dining_name}" required />
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">íƒ€ì…</label>
            <select class="edit-form-select" name="type" required>
              <option value="í•œì‹" th:selected="${dining.type == 'í•œì‹'}">í•œì‹</option>
              <option value="í”„ë Œì¹˜" th:selected="${dining.type == 'í”„ë Œì¹˜'}">í”„ë Œì¹˜</option>
              <option value="íšŒì›ì œ ë ˆìŠ¤í† ë‘" th:selected="${dining.type == 'íšŒì›ì œ ë ˆìŠ¤í† ë‘'}">íšŒì›ì œ ë ˆìŠ¤í† ë‘</option>
              <option value="ë ˆìŠ¤í† ë‘ & ë°”" th:selected="${dining.type == 'ë ˆìŠ¤í† ë‘ & ë°”'}">ë ˆìŠ¤í† ë‘ & ë°”</option>
              <option value="ìŠ¤ì¹´ì´ ë°”" th:selected="${dining.type == 'ìŠ¤ì¹´ì´ ë°”'}">ìŠ¤ì¹´ì´ ë°”</option>
              <option value="í”„ë¦¬ë¯¸ì—„ ë² ì´ì»¤ë¦¬ & ì¹´í˜" th:selected="${dining.type == 'í”„ë¦¬ë¯¸ì—„ ë² ì´ì»¤ë¦¬ & ì¹´í˜'}">í”„ë¦¬ë¯¸ì—„ ë² ì´ì»¤ë¦¬ & ì¹´í˜</option>
              <option value="ì¸ë£¸ ë‹¤ì´ë‹" th:selected="${dining.type == 'ì¸ë£¸ ë‹¤ì´ë‹'}">ì¸ë£¸ ë‹¤ì´ë‹</option>
            </select>
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ìœ„ì¹˜</label>
            <input class="edit-form-input" type="text" name="location" th:value="${dining.location}" required />
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ë¬¸ì˜ë²ˆí˜¸</label>
            <input class="edit-form-input" type="text" name="phone_number" th:value="${dining.phone_number}" required />
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ë‹´ë‹¹ì</label>
            <input class="edit-form-input" type="text" name="manager_name" th:value="${dining.manager_name}" required />
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€</label>
            <select class="edit-form-select" name="dining_resv_availability">
              <option value="Y" th:selected="${dining.dining_resv_availability == 'Y'}">ê°€ëŠ¥</option>
              <option value="N" th:selected="${dining.dining_resv_availability == 'N'}">ë¶ˆê°€ëŠ¥</option>
            </select>
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ë¶„ë¥˜</label>
            <select class="edit-form-select" name="dining_classification" required>
              <option value="ë ˆìŠ¤í† ë‘" th:selected="${dining.dining_classification == 'ë ˆìŠ¤í† ë‘'}">ë ˆìŠ¤í† ë‘</option>
              <option value="ë¼ìš´ì§€ &amp; ë°”" th:selected="${dining.dining_classification == 'ë¼ìš´ì§€ & ë°”'}">ë¼ìš´ì§€ & ë°”</option>
              <option value="ë² ì´ì»¤ë¦¬ &amp; ì¹´í˜" th:selected="${dining.dining_classification == 'ë² ì´ì»¤ë¦¬ & ì¹´í˜'}">ë² ì´ì»¤ë¦¬ & ì¹´í˜</option>
              <option value="ë£¸ì„œë¹„ìŠ¤" th:selected="${dining.dining_classification == 'ë£¸ì„œë¹„ìŠ¤'}">ë£¸ì„œë¹„ìŠ¤</option>
            </select>
          </div>
        </div>
        <div class="form-data-section">
          <div class="form-data-title">ìƒì„¸ ì •ë³´</div>
          <div class="edit-form-section">
            <label class="edit-form-label">ì†Œê°œ</label>
            <textarea class="edit-form-textarea" name="dining_introduction" rows="3" th:text="${dining.dining_introduction}"></textarea>
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ìƒì„¸ì •ë³´</label>
            <textarea class="edit-form-textarea" name="dining_detailinfo" rows="5" th:text="${dining.dining_detailinfo}"></textarea>
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ì˜ì—…ì‹œê°„</label>
            <textarea class="edit-form-textarea" name="dining_operation_hours" rows="3" th:text="${dining.dining_operation_hours}"></textarea>
          </div>
        </div>
        <div class="edit-form-btn-area">
          <button type="button" class="list-btn modern-btn" id="submit-btn">ë°ì´í„° ìˆ˜ì •</button>
        </div>
      </form>

      <hr style="margin: 40px 0; border: none; border-top: 2px solid #e0e0e0;">

      <!-- íŒŒì¼ ì—…ë¡œë“œ í¼ -->
      <form id="diningFileForm" th:action="@{/admin/dining/editFiles}" method="post" enctype="multipart/form-data">
        <input type="hidden" name="dining_id" th:value="${dining.dining_id}" />

        <div class="file-upload-section">
          <div class="file-upload-title">ë©”ì¸ ì´ë¯¸ì§€</div>
          <div class="file-input-wrapper">
            <input type="file" name="main_image_file" accept="image/*" />
          </div>
          <input type="hidden" name="main_image_url" />
          <img th:if="${dining.dining_main_image != null}" th:src="@{${dining.dining_main_image}}" class="edit-form-img-preview" />
        </div>
        
        <div class="file-upload-section">
          <div class="file-upload-title">ë¡œê³  ì´ë¯¸ì§€</div>
          <div class="file-input-wrapper">
            <input type="file" name="logo_image_file" accept="image/*" />
          </div>
          <input type="hidden" name="logo_image_url" />
          <img th:if="${dining.dining_logo_image != null}" th:src="@{${dining.dining_logo_image}}" class="edit-form-img-preview" />
        </div>
        
        <div class="file-upload-section">
          <div class="file-upload-title">ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</div>
          <div class="edit-form-img-list" id="carousel-img-list" style="display:flex; flex-direction:column; gap:0;">
            <th:block th:each="img, iterStat : ${dining.dining_carousel_images}">
              <div class="carousel-img-item" th:attr="data-index=${iterStat.index}" style="position:relative; display:flex; align-items:center; padding:12px 0; border-bottom:1px solid #e0e0e0;">
                <span style="width:32px; display:inline-block; text-align:center; font-weight:bold;">[[${iterStat.index + 1}]]</span>
                <img th:src="@{${img}}" style="max-width:120px; border:1px solid #ccc; border-radius:4px; margin:0 16px;" />
                <button type="button" class="action-btn delete-btn"
                        th:onclick="'deleteCarouselImage(this)'">ì‚­ì œ</button>
                <input type="file" th:name="'replace_carousel_image_' + ${iterStat.index}"
                       style="display:none;" th:onchange="'replaceCarouselImage(event, ' + ${iterStat.index} + ')'" />
                <button type="button" class="action-btn replace-btn" th:onclick="'triggerReplace(' + ${iterStat.index} + ')'">êµì²´</button>
                <input type="hidden" name="carousel_image_urls" th:value="${img}" />
              </div>
            </th:block>
          </div>
        </div>

        <div class="edit-form-btn-area" style="margin-bottom: 100px;">
          <button type="button" class="list-btn modern-btn" onclick="saveCarouselImages()">ì´ë¯¸ì§€ìˆ˜ì •</button>
          <a th:href="@{/admin/dining}"><button type="button" class="list-btn modern-btn">ë’¤ë¡œê°€ê¸°</button></a>
        </div>
      </form>
    </section>
  </main>
</div>
<script>
let deletedCarouselUrls = [];
let replacedCarouselFiles = {};
let carouselOrder = [];
let mainImageFile = null;
let logoImageFile = null;

// ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜ë“¤
function validateDiningForm() {
  const errors = [];
  
  // 1. í•„ìˆ˜ í•„ë“œ ê²€ì‚¬
  const requiredFields = {
    'dining_name': 'ì´ë¦„',
    'type': 'íƒ€ì…', 
    'location': 'ìœ„ì¹˜',
    'phone_number': 'ë¬¸ì˜ë²ˆí˜¸',
    'manager_name': 'ë‹´ë‹¹ì',
    'dining_classification': 'ë¶„ë¥˜'
  };
  
  for (const [fieldName, fieldLabel] of Object.entries(requiredFields)) {
    const field = document.querySelector(`[name="${fieldName}"]`);
    if (!field || !field.value.trim()) {
      errors.push(`${fieldLabel}ì€(ëŠ”) í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.`);
    }
  }
  
  // 2. ë°ì´í„° ê¸¸ì´ ê²€ì‚¬ (í•œê¸€ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •)
  const lengthValidations = {
    'dining_name': { max: 66, label: 'ì´ë¦„' }, // 200ë°”ì´íŠ¸ Ã· 3ë°”ì´íŠ¸ = ì•½ 66ì
    'type': { max: 33, label: 'íƒ€ì…' }, // 100ë°”ì´íŠ¸ Ã· 3ë°”ì´íŠ¸ = ì•½ 33ì
    'location': { max: 6, label: 'ìœ„ì¹˜' }, // 20ë°”ì´íŠ¸ Ã· 3ë°”ì´íŠ¸ = ì•½ 6ì
    'phone_number': { max: 33, label: 'ë¬¸ì˜ë²ˆí˜¸' }, // 100ë°”ì´íŠ¸ Ã· 3ë°”ì´íŠ¸ = ì•½ 33ì
    'manager_name': { max: 5, label: 'ë‹´ë‹¹ì' }, // 15ë°”ì´íŠ¸ Ã· 3ë°”ì´íŠ¸ = 5ì
    'dining_introduction': { max: 333, label: 'ì†Œê°œ' }, // 1000ë°”ì´íŠ¸ Ã· 3ë°”ì´íŠ¸ = ì•½ 333ì
    'dining_detailinfo': { max: 1333, label: 'ìƒì„¸ì •ë³´' }, // 4000ë°”ì´íŠ¸ Ã· 3ë°”ì´íŠ¸ = ì•½ 1333ì
    'dining_classification': { max: 33, label: 'ë¶„ë¥˜' }, // 100ë°”ì´íŠ¸ Ã· 3ë°”ì´íŠ¸ = ì•½ 33ì
    'dining_operation_hours': { max: 333, label: 'ì˜ì—…ì‹œê°„' } // 1000ë°”ì´íŠ¸ Ã· 3ë°”ì´íŠ¸ = ì•½ 333ì
  };
  
  for (const [fieldName, validation] of Object.entries(lengthValidations)) {
    const field = document.querySelector(`[name="${fieldName}"]`);
    if (field && field.value && field.value.length > validation.max) {
      errors.push(`${validation.label}ì€(ëŠ”) ${validation.max}ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤. (í˜„ì¬: ${field.value.length}ì)`);
    }
  }
  
  // 3. ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì‚¬
  const phoneField = document.querySelector('[name="phone_number"]');
  if (phoneField && phoneField.value.trim()) {
    const phonePattern = /^[0-9-]+$/;
    if (!phonePattern.test(phoneField.value.trim())) {
      errors.push('ë¬¸ì˜ë²ˆí˜¸ëŠ” ìˆ«ìì™€ í•˜ì´í”ˆ(-)ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
    }
  }
  
  // 4. ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€ ê²€ì‚¬ (Y/Në§Œ í—ˆìš©)
  const resvField = document.querySelector('[name="dining_resv_availability"]');
  if (resvField && resvField.value && !['Y', 'N'].includes(resvField.value)) {
    errors.push('ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€ëŠ” Y ë˜ëŠ” Në§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
  }
  
  return errors;
}

// ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
function showValidationErrors(errors) {
  if (errors.length === 0) return;
  
  let errorMessage = 'ë‹¤ìŒ ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”:\n\n';
  errors.forEach((error, index) => {
    errorMessage += `${index + 1}. ${error}\n`;
  });
  
  alert(errorMessage);
}

// ë°ì´í„° ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
document.addEventListener('DOMContentLoaded', function() {
  const submitBtn = document.getElementById('submit-btn');
  if (submitBtn) {
    submitBtn.addEventListener('click', function(e) {
      e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë§‰ê¸°
      
      // ìœ íš¨ì„± ê²€ì‚¬ ìˆ˜í–‰
      const validationErrors = validateDiningForm();
      if (validationErrors.length > 0) {
        showValidationErrors(validationErrors);
        return; // ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ í˜„ì¬ í˜ì´ì§€ì— ë¨¸ë¬´ë¦„
      }
      
      // ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼ ì‹œ ê¸°ì¡´ í¼ ì œì¶œ
      const diningDataForm = document.getElementById('diningDataForm');
      if (diningDataForm) {
        diningDataForm.submit();
      }
    });
  }
});

function renumberCarouselItems() {
  const carouselList = document.getElementById('carousel-img-list');
  Array.from(carouselList.children).forEach(function(child, i) {
    const span = child.querySelector('span');
    if (span) span.textContent = i + 1;
    child.setAttribute('data-index', i);
  });
}

function deleteCarouselImage(button) {
  const item = button.closest('.carousel-img-item');
  if (!item) return;
  
  const urlInput = item.querySelector('input[name="carousel_image_urls"]');
  if (urlInput && urlInput.value) {
    deletedCarouselUrls.push(urlInput.value); // URLì„ ì§ì ‘ ì €ì¥
    // ë””ë²„ê¹…ìš© ë¡œê·¸
    console.log('ì‚­ì œë  ì´ë¯¸ì§€ URL:', urlInput.value);
  }
  item.parentNode.removeChild(item); // ì™„ì „íˆ DOMì—ì„œ ì œê±°
  renumberCarouselItems();
}

function triggerReplace(idx) {
  let input = document.getElementsByName('replace_carousel_image_' + idx)[0];
  if (!input) {
    input = document.createElement('input');
    input.type = 'file';
    input.name = 'replace_carousel_image_' + idx;
    input.style.display = 'none';
    input.accept = 'image/*';
    input.onchange = function(event) { 
      replaceCarouselImage(event, idx); 
    };
    document.getElementById('diningFileForm').appendChild(input);
  }
  input.click();
}

function replaceCarouselImage(event, idx) {
  // ë¯¸ë¦¬ë³´ê¸° ë³€ê²½
  let img = document.querySelectorAll('.carousel-img-item img')[idx];
  img.src = URL.createObjectURL(event.target.files[0]);
  
  // êµì²´ëœ íŒŒì¼ì„ í•´ë‹¹ itemì— ì €ì¥
  const items = document.querySelectorAll('.carousel-img-item');
  if (items[idx]) {
    items[idx].file = event.target.files[0]; // íŒŒì¼ ê°ì²´ ì €ì¥
    console.log('êµì²´ëœ íŒŒì¼ ì €ì¥:', event.target.files[0].name, 'ì¸ë±ìŠ¤:', idx);
  }
  
  // êµì²´ íŒŒì¼ hidden input ì¶”ê°€ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
  let input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'replace_carousel_indexes';
  input.value = idx;
  document.getElementById('diningFileForm').appendChild(input);
}

function uploadAllImages() {
  console.log('uploadAllImages called!');
  const diningId = document.querySelector('input[name="dining_id"]').value;

  // ë©”ì¸ ì´ë¯¸ì§€
  const mainFile = document.querySelector('input[name="main_image_file"]').files[0];
  if (mainFile) {
    uploadSingleFile(diningId, mainFile, 'main');
  }

  // ë¡œê³  ì´ë¯¸ì§€
  const logoFile = document.querySelector('input[name="logo_image_file"]').files[0];
  if (logoFile) {
    uploadSingleFile(diningId, logoFile, 'logo');
  }

  // ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€(ì—¬ëŸ¬ ì¥)
  const carouselFiles = document.querySelector('input[name="carousel_image_files"]').files;
  for (let i = 0; i < carouselFiles.length; i++) {
    uploadSingleFile(diningId, carouselFiles[i], 'carousel', i);
  }
}

function uploadSingleFile(diningId, file, type, idx) {
  const formData = new FormData();
  formData.append('dining_id', diningId);
  if (type === 'main') {
    formData.append('main_image_file', file);
  } else if (type === 'logo') {
    formData.append('logo_image_file', file);
  } else if (type === 'carousel') {
    formData.append('carousel_image_file', file);
    formData.append('carousel_index', idx);
  }
  return fetch('/admin/dining/editFiles', {
    method: 'POST',
    body: formData
  })
  .then(res => {
    if (!res.ok) throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
    return res.json();
  })
  .then(data => {
    // ì—…ë¡œë“œ ì„±ê³µ ì‹œ ë¯¸ë¦¬ë³´ê¸° ë³€ê²½
    if (type === 'main') {
      // ë©”ì¸ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë³€ê²½
      const mainImg = document.querySelector('input[name="main_image_file"]').nextElementSibling;
      if (mainImg && mainImg.tagName === 'IMG') {
        mainImg.src = data.imageUrl + '?t=' + new Date().getTime();
      }
    } else if (type === 'logo') {
      // ë¡œê³  ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë³€ê²½
      const logoImg = document.querySelector('input[name="logo_image_file"]').nextElementSibling;
      if (logoImg && logoImg.tagName === 'IMG') {
        logoImg.src = data.imageUrl + '?t=' + new Date().getTime();
      }
    } else if (type === 'carousel') {
      // idxë²ˆì§¸ ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë³€ê²½
      const carouselImgs = document.querySelectorAll('.carousel-img-item img');
      if (carouselImgs[idx]) {
        carouselImgs[idx].src = data.imageUrl + '?t=' + new Date().getTime();
      }
    }
  });
}

function saveCarouselImages() {
  const diningId = document.querySelector('input[name="dining_id"]').value;
  const items = document.querySelectorAll('.carousel-img-item');
  const uploadPromises = [];

  console.log('=== ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì €ì¥ ì‹œì‘ ===');
  console.log('ì´ ì¼€ëŸ¬ì…€ ì•„ì´í…œ ìˆ˜:', items.length);
  console.log('ë©”ì¸ ì´ë¯¸ì§€ íŒŒì¼:', mainImageFile ? mainImageFile.name : 'ì—†ìŒ');
  console.log('ë¡œê³  ì´ë¯¸ì§€ íŒŒì¼:', logoImageFile ? logoImageFile.name : 'ì—†ìŒ');

  // ë©”ì¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ
  if (mainImageFile) {
    const formData = new FormData();
    formData.append('dining_id', diningId);
    formData.append('main_image_file', mainImageFile);
    uploadPromises.push(
      fetch('/admin/dining/editFiles', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        document.querySelector('input[name="main_image_url"]').value = data.imageUrl;
      })
    );
  }

  // ë¡œê³  ì´ë¯¸ì§€ ì—…ë¡œë“œ
  if (logoImageFile) {
    const formData = new FormData();
    formData.append('dining_id', diningId);
    formData.append('logo_image_file', logoImageFile);
    uploadPromises.push(
      fetch('/admin/dining/editFiles', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        document.querySelector('input[name="logo_image_url"]').value = data.imageUrl;
      })
    );
  }

  // ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì¶”ê°€/êµì²´ëœ ê²ƒë§Œ)
  items.forEach((item, idx) => {
    const file = item.file;
    console.log(`ì¼€ëŸ¬ì…€ ì•„ì´í…œ ${idx + 1}:`, {
      hasFile: !!file,
      fileName: file ? file.name : 'ì—†ìŒ',
      hasUrl: !!item.querySelector('input[name="carousel_image_urls"]')?.value
    });
    
    if (file) {
      console.log(`ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘: ${file.name}, ì¸ë±ìŠ¤: ${idx + 1}`);
      const formData = new FormData();
      formData.append('dining_id', diningId);
      formData.append('carousel_image_file', file);
      formData.append('carousel_index', idx + 1);
      uploadPromises.push(
        fetch('/admin/dining/editFiles', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          console.log(`ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ: ${data.imageUrl}`);
          const urlInput = item.querySelector('input[name="carousel_image_urls"]');
          if (urlInput) urlInput.value = data.imageUrl;
        })
      );
    }
  });

  // ëª¨ë“  ì—…ë¡œë“œê°€ ëë‚œ í›„ ìˆœì„œ ë™ê¸°í™”
  Promise.all(uploadPromises).then(() => {
    const orderedUrls = [];
    items.forEach(item => {
      const urlInput = item.querySelector('input[name="carousel_image_urls"]');
      if (urlInput && urlInput.value) {
        orderedUrls.push(urlInput.value);
      }
    });
    updateCarouselOrderOnServer(diningId, orderedUrls);
    // ì—…ë¡œë“œ í›„ íŒŒì¼ ë³€ìˆ˜ ì´ˆê¸°í™”
    mainImageFile = null;
    logoImageFile = null;
    items.forEach(item => { item.file = null; });
  }).catch(() => {
    alert('ì—…ë¡œë“œ ì‹¤íŒ¨');
  });
}

function updateCarouselOrderOnServer(diningId, imageUrls) {
  console.log('=== ì¼€ëŸ¬ì…€ ìˆœì„œ ì—…ë°ì´íŠ¸ ===');
  console.log('ë‹¤ì´ë‹ ID:', diningId);
  console.log('ì´ë¯¸ì§€ URLs:', imageUrls);
  console.log('ì‚­ì œë  ì´ë¯¸ì§€ URL ì „ì²´:', deletedCarouselUrls);

  const bodyData = `dining_id=${encodeURIComponent(diningId)}&` +
    imageUrls.map(url => `image_urls=${encodeURIComponent(url)}`).join('&') +
    deletedCarouselUrls.map(url => `&deleted_image_urls=${encodeURIComponent(url)}`).join('');
  console.log('fetch body:', bodyData); // ì‹¤ì œ ì „ì†¡ë˜ëŠ” ë°ì´í„° í™•ì¸
  fetch('/admin/dining/updateCarouselOrder', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: bodyData
  })
  .then(res => {
    if (res.ok) {
      alert('ì €ì¥ ì™„ë£Œ!');
      location.reload();
    } else {
      alert('ìˆœì„œ ì €ì¥ ì‹¤íŒ¨');
    }
  })
  .catch(error => {
    console.error('Error updating carousel order:', error);
    alert('ìˆœì„œ ì €ì¥ ì‹¤íŒ¨');
  });
}

function uploadSingleFileAndUpdateHidden(diningId, file, idx, type, div) {
  const formData = new FormData();
  formData.append('dining_id', diningId);
  if (type === 'main') {
    formData.append('main_image_file', file);
  } else if (type === 'logo') {
    formData.append('logo_image_file', file);
  } else {
    formData.append('carousel_image_file', file);
    formData.append('carousel_index', idx + 1);
  }
  fetch('/admin/dining/editFiles', {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    // ì—…ë¡œë“œ í›„ í•´ë‹¹ .carousel-img-itemì˜ hidden input valueë¥¼ ìƒˆ URLë¡œ ê°±ì‹ 
    const urlInput = div.querySelector('input[name="carousel_image_urls"]');
    if (urlInput) urlInput.value = data.imageUrl;
  });
}

// 1. ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì¶”ê°€ ë²„íŠ¼ ì¶”ê°€ (ì¼€ëŸ¬ì…€ ì˜ì—­ ìœ„ì—)
// <button type="button" onclick="addCarouselImage()">ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì¶”ê°€</button>
// (HTMLì— ì§ì ‘ ì¶”ê°€í•˜ê±°ë‚˜, ì•„ë˜ ì½”ë“œ ì°¸ê³ )
document.addEventListener('DOMContentLoaded', function() {
  const addBtn = document.createElement('button');
  addBtn.type = 'button';
  addBtn.textContent = 'ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì¶”ê°€';
  addBtn.onclick = addCarouselImage;
  const carouselSection = document.getElementById('carousel-img-list');
  if (carouselSection) {
    carouselSection.parentNode.insertBefore(addBtn, carouselSection);
  }
});

// 2. input[name='carousel_image_files'] ì œê±° (HTMLì—ì„œ ì‚­ì œ)
// <input type="file" id="add-carousel-images" name="carousel_image_files" accept="image/*" multiple />
// ì´ ì¤„ì„ ì‚­ì œí•˜ì„¸ìš”.

// 3. addCarouselImage í•¨ìˆ˜ëŠ” ìƒˆë¡œìš´ .carousel-img-itemì„ ì¶”ê°€
function addCarouselImage() {
  const carouselList = document.getElementById('carousel-img-list');
  const idx = carouselList.children.length;
  const div = document.createElement('div');
  div.className = 'carousel-img-item';
  div.style.position = 'relative';
  div.style.display = 'flex';
  div.style.alignItems = 'center';
  div.style.padding = '12px 0';
  div.style.borderBottom = '1px solid #e0e0e0';
  div.setAttribute('data-index', idx);
  // ë²ˆí˜¸(ìˆœë²ˆ)
  const numSpan = document.createElement('span');
  numSpan.style.width = '32px';
  numSpan.style.display = 'inline-block';
  numSpan.style.textAlign = 'center';
  numSpan.style.fontWeight = 'bold';
  numSpan.textContent = idx + 1;
  div.appendChild(numSpan);
  // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
  const img = document.createElement('img');
  img.style.maxWidth = '120px';
  img.style.border = '1px solid #ccc';
  img.style.borderRadius = '4px';
  img.style.margin = '0 16px';
  div.appendChild(img);
  // íŒŒì¼ input
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.onchange = function(e) {
    if (e.target.files[0]) {
      img.src = URL.createObjectURL(e.target.files[0]);
      div.file = e.target.files[0]; // íŒŒì¼ ê°ì²´ ì €ì¥
      hiddenInput.value = '';
    }
  };
  div.appendChild(fileInput);
  // hidden input (ì—…ë¡œë“œ í›„ ì„œë²„ì—ì„œ ë°˜í™˜ëœ URLë¡œ ê°±ì‹ )
  const hiddenInput = document.createElement('input');
  hiddenInput.type = 'hidden';
  hiddenInput.name = 'carousel_image_urls';
  div.appendChild(hiddenInput);
  // ì‚­ì œ ë²„íŠ¼
  const delBtn = document.createElement('button');
  delBtn.type = 'button';
  delBtn.textContent = 'ì‚­ì œ';
  delBtn.className = 'action-btn delete-btn';
  delBtn.onclick = function() { deleteCarouselImage(this); };
  div.appendChild(delBtn);
  // êµì²´ ë²„íŠ¼
  const replaceBtn = document.createElement('button');
  replaceBtn.type = 'button';
  replaceBtn.textContent = 'êµì²´';
  replaceBtn.className = 'action-btn replace-btn';
  replaceBtn.onclick = function() { fileInput.click(); };
  div.appendChild(replaceBtn);
  // ì¶”ê°€
  carouselList.appendChild(div);
  renumberCarouselItems();
}
</script>
<script>
document.getElementById('diningFileForm').addEventListener('submit', function(e) {
  // input[file] ê°œìˆ˜ í™•ì¸
  const files = this.querySelectorAll('input[type="file"]');
  console.log('input[file] ê°œìˆ˜:', files.length);
  files.forEach((input, idx) => {
    console.log(idx, input.name, input.files.length, input.files[0]?.name);
  });

  // input[type=hidden]ë„ í™•ì¸
  const hiddens = this.querySelectorAll('input[type="hidden"]');
  hiddens.forEach((input, idx) => {
    console.log('hidden', idx, input.name, input.value);
  });
});
</script>
<script>
// ë©”ì¸ ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°ë§Œ ê°±ì‹ , ì—…ë¡œë“œëŠ” ì €ì¥ ì‹œì—ë§Œ
const mainInput = document.querySelector('input[name="main_image_file"]');
if (mainInput) {
  mainInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      mainImageFile = file;
      // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ì°¾ê¸° (input ë‹¤ìŒì— ìˆëŠ” img íƒœê·¸)
      const img = this.parentNode.parentNode.querySelector('img');
      if (img) {
        img.src = URL.createObjectURL(file);
        img.style.display = 'block';
      }
    }
  });
}
// ë¡œê³  ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°ë§Œ ê°±ì‹ , ì—…ë¡œë“œëŠ” ì €ì¥ ì‹œì—ë§Œ
const logoInput = document.querySelector('input[name="logo_image_file"]');
if (logoInput) {
  logoInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      logoImageFile = file;
      // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ì°¾ê¸° (input ë‹¤ìŒì— ìˆëŠ” img íƒœê·¸)
      const img = this.parentNode.parentNode.querySelector('img');
      if (img) {
        img.src = URL.createObjectURL(file);
        img.style.display = 'block';
      }
    }
  });
}
// ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì—¬ëŸ¬ ì¥ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì¦‰ì‹œ ë³€ê²½ (ì¶”ê°€ëœ íŒŒì¼ë§Œ ë¯¸ë¦¬ë³´ê¸°)
const carouselInput = document.querySelector('input[name="carousel_image_files"]');
if (carouselInput) {
  carouselInput.addEventListener('change', function(e) {
    const files = e.target.files;
    const carouselList = document.getElementById('carousel-img-list');
    // ê¸°ì¡´ ë¯¸ë¦¬ë³´ê¸°ëŠ” ê·¸ëŒ€ë¡œ ë‘ê³ , ìƒˆë¡œ ì„ íƒí•œ íŒŒì¼ë§Œ ì¶”ê°€ ë¯¸ë¦¬ë³´ê¸°ë¡œ ë³´ì—¬ì¤Œ
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      // ì´ë¯¸ ìˆëŠ” ë¯¸ë¦¬ë³´ê¸°ëŠ” ê±´ë„ˆëœ€
      if (carouselList.children[i]) {
        const img = carouselList.children[i].querySelector('img');
        if (img) {
          img.src = URL.createObjectURL(file);
        }
      }
    }
  });
}
</script>
</body>
</html> 