<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<title>ë‹¤ì´ë‹ ì •ë³´ ì¶”ê°€</title>
<link rel="stylesheet" href="/admin_common_assets/css/common.css">
<style>
  .edit-form-label { display: block; margin-top: 24px; font-weight: bold; margin-bottom: 15px; }
  .edit-form-input, .edit-form-textarea, .edit-form-select { width: 100%; padding: 8px; margin-top: 4px; border-radius: 5px; }
  .edit-form-img-preview { max-width: 200px; margin-top: 8px; display: block; }
  .edit-form-img-list { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px; }
  .edit-form-img-list img { max-width: 120px; border: 1px solid #ccc; border-radius: 4px; }
  .edit-form-section { margin-bottom: 32px; width: 50%; }
  .edit-form-btn-area { margin-top: 32px; display: flex; gap: 16px; }

  .modern-btn, .list-btn {
    background: linear-gradient(90deg, #856956 0%, #a88d7b 100%);
    color: #fff;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    padding: 0.5rem 1rem;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(133, 105, 86, 0.08);
    transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
    margin: 0 8px;
    letter-spacing: 0.5px;
  }
  .modern-btn:hover, .list-btn:hover {
    background: linear-gradient(90deg, #6d5747 0%, #856956 100%);
    box-shadow: 0 4px 16px rgba(133, 105, 86, 0.15);
    transform: translateY(-2px) scale(1.03);
  }
  .dining-section {
    margin-top : 50px;
  }
  
  /* í¼ ë°ì´í„° ì„¹ì…˜ ìŠ¤íƒ€ì¼ (ì´ë¯¸ì§€ ì—…ë¡œë“œì™€ êµ¬ë¶„) */
  .form-data-section {
    background: #f0f8ff;
    border: 2px dashed #e3f2fd;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    transition: border-color 0.3s ease;
  }
  .form-data-section:hover {
    border-color: #2196f3;
  }
  
  /* íŒŒì¼ ì„ íƒ ì˜ì—­ êµ¬ë¶„ ìŠ¤íƒ€ì¼ */
  .file-upload-section {
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    transition: border-color 0.3s ease;
  }
  .file-upload-section:hover {
    border-color: #856956;
  }
  
  .form-data-title {
    font-size: 18px;
    font-weight: 600;
    color: #000000;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .form-data-title::before {
    content: "ğŸ“";
    font-size: 20px;
  }
  
  .file-upload-title {
    font-size: 18px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .file-upload-title::before {
    content: "ğŸ“";
    font-size: 20px;
  }
  
  /* ëª¨ë˜í•œ ì‚­ì œ/êµì²´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  .action-btn {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-right: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .action-btn:hover {
    background: linear-gradient(135deg, #495057 0%, #343a40 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  .delete-btn {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  }
  .delete-btn:hover {
    background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
  }
  .replace-btn {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
  }
  .replace-btn:hover {
    background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
  }
  
  /* íŒŒì¼ ì…ë ¥ ìŠ¤íƒ€ì¼ ê°œì„  */
  .file-input-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
  }
  .file-input-wrapper input[type="file"] {
    width: 100%;
    padding: 10px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    background: white;
    transition: border-color 0.3s ease;
  }
  .file-input-wrapper input[type="file"]:hover {
    border-color: #856956;
  }
  .file-input-wrapper input[type="file"]:focus {
    outline: none;
    border-color: #856956;
    box-shadow: 0 0 0 3px rgba(133, 105, 86, 0.1);
  }
</style>
</head>
<body>
<th:block th:replace="~{administrator/fragments/admin_header :: admin_header}"></th:block>
<th:block th:replace="~{administrator/fragments/admin_sidebar :: admin_sidebar}"></th:block>
<div class="body-pd">
  <main class="main-content">
    <section class="dining-section">
      <h1>ë‹¤ì´ë‹ ì •ë³´ ì¶”ê°€</h1>
      <form id="diningDataForm" th:action="@{/admin/dining/add}" method="post">
        <div class="form-data-section">
          <div class="form-data-title">ê¸°ë³¸ ì •ë³´</div>
          <div class="edit-form-section">
            <label class="edit-form-label">ì´ë¦„</label>
            <input class="edit-form-input" type="text" name="dining_name" required placeholder="ì˜ˆ) ìŠ¤í…Œì´, ëª¨ë˜ ë ˆìŠ¤í† ë‘" />
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">íƒ€ì…</label>
            <select class="edit-form-select" name="type" required>
              <option value="í•œì‹">í•œì‹</option>
              <option value="í”„ë Œì¹˜">í”„ë Œì¹˜</option>
              <option value="íšŒì›ì œ ë ˆìŠ¤í† ë‘">íšŒì›ì œ ë ˆìŠ¤í† ë‘</option>
              <option value="ë ˆìŠ¤í† ë‘ & ë°”">ë ˆìŠ¤í† ë‘ & ë°”</option>
              <option value="ìŠ¤ì¹´ì´ ë°”">ìŠ¤ì¹´ì´ ë°”</option>
              <option value="í”„ë¦¬ë¯¸ì—„ ë² ì´ì»¤ë¦¬ & ì¹´í˜">í”„ë¦¬ë¯¸ì—„ ë² ì´ì»¤ë¦¬ & ì¹´í˜</option>
              <option value="ì¸ë£¸ ë‹¤ì´ë‹">ì¸ë£¸ ë‹¤ì´ë‹</option>
            </select>
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ìœ„ì¹˜</label>
            <input class="edit-form-input" type="text" name="location" required placeholder="ì˜ˆ) 81ì¸µ" />
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ë¬¸ì˜ë²ˆí˜¸</label>
            <input class="edit-form-input" type="text" name="phone_number" required placeholder="ì˜ˆ) 02-1234-5678" />
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ë‹´ë‹¹ì</label>
            <input class="edit-form-input" type="text" name="manager_name" required placeholder="ì˜ˆ) í™ê¸¸ë™" />
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ì˜ˆì•½ ê°€ëŠ¥ ì—¬ë¶€</label>
            <select class="edit-form-select" name="dining_resv_availability">
              <option value="Y">ê°€ëŠ¥</option>
              <option value="N">ë¶ˆê°€ëŠ¥</option>
            </select>
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ë¶„ë¥˜</label>
            <select class="edit-form-select" name="dining_classification" required>
              <option value="ë ˆìŠ¤í† ë‘">ë ˆìŠ¤í† ë‘</option>
              <option value="ë¼ìš´ì§€ &amp; ë°”">ë¼ìš´ì§€ & ë°”</option>
              <option value="ë² ì´ì»¤ë¦¬ &amp; ì¹´í˜">ë² ì´ì»¤ë¦¬ & ì¹´í˜</option>
              <option value="ë£¸ì„œë¹„ìŠ¤">ë£¸ì„œë¹„ìŠ¤</option>
            </select>
          </div>
        </div>
        
        <div class="form-data-section">
          <div class="form-data-title">ìƒì„¸ ì •ë³´</div>
          <div class="edit-form-section">
            <label class="edit-form-label">ì†Œê°œ</label>
            <textarea class="edit-form-textarea" name="dining_introduction" rows="3" placeholder="ê°„ë‹¨í•œ ì†Œê°œë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ) ë¯¸ì‰ë¦° 3ìŠ¤íƒ€ ì…°í”„ê°€ ì„ ë³´ì´ëŠ” í”„ë Œì¹˜ ë ˆìŠ¤í† ë‘"></textarea>
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ìƒì„¸ì •ë³´</label>
            <textarea class="edit-form-textarea" name="dining_detailinfo" rows="5" placeholder="ìƒì„¸ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ) ë“œë ˆìŠ¤ì½”ë“œ, ì¢Œì„ìˆ˜, íŠ¹ì´ì‚¬í•­ ë“±"></textarea>
          </div>
          <div class="edit-form-section">
            <label class="edit-form-label">ì˜ì—…ì‹œê°„</label>
            <textarea class="edit-form-textarea" name="dining_operation_hours" rows="3" placeholder="ì˜ˆ) 11:30~22:00 (Break Time 15:00~17:30)"></textarea>
          </div>
        </div>
      </form>

      <!-- íŒŒì¼ ì—…ë¡œë“œ í¼ -->
      <form id="diningFileForm" th:action="@{/admin/dining/editFiles}" method="post" enctype="multipart/form-data">
        <input type="hidden" name="dining_id" />

        <div class="file-upload-section">
          <div class="file-upload-title">ë©”ì¸ ì´ë¯¸ì§€</div>
          <div class="file-input-wrapper">
            <input type="file" name="main_image_file" accept="image/*" />
          </div>
          <input type="hidden" name="main_image_url" />
          <img class="edit-form-img-preview" id="main-image-preview" style="display: none;" />
        </div>
        
        <div class="file-upload-section">
          <div class="file-upload-title">ë¡œê³  ì´ë¯¸ì§€</div>
          <div class="file-input-wrapper">
            <input type="file" name="logo_image_file" accept="image/*" />
          </div>
          <input type="hidden" name="logo_image_url" />
          <img class="edit-form-img-preview" id="logo-image-preview" style="display: none;" />
        </div>
        
        <div class="file-upload-section">
          <div class="file-upload-title">ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)</div>
          <button type="button" id="add-carousel-btn" class="action-btn replace-btn" style="margin-bottom:12px;">ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì¶”ê°€</button>
          <input type="file" id="add-carousel-images" accept="image/*" multiple style="display:none;" />
          <div class="edit-form-img-list" id="carousel-img-list" style="display:flex; flex-direction:column; gap:0;"></div>
        </div>

        <div class="edit-form-btn-area" style="margin-bottom: 100px;">
          <button type="submit" class="list-btn modern-btn">ì¶”ê°€</button>
          <button type="button" class="list-btn modern-btn" onclick="window.history.back()">ì·¨ì†Œ</button>
        </div>
      </form>
    </section>
  </main>
</div>
<script>
// ì‚­ì œëœ ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ URLë“¤ì„ ì €ì¥í•  ë°°ì—´
let deletedCarouselUrls = [];

// 1. 'ì¶”ê°€' ë²„íŠ¼ í´ë¦­ ì‹œ ë‹¤ì´ë‹ ì •ë³´ + ì´ë¯¸ì§€ + ì¼€ëŸ¬ì…€ ì €ì¥ì´ í•œ ë²ˆì— ì¼ì–´ë‚˜ë„ë¡ ì²˜ë¦¬
const diningDataForm = document.getElementById('diningDataForm');
if (diningDataForm) {
  diningDataForm.addEventListener('submit', function(e) {
    e.preventDefault(); // ê¸°ë³¸ submit ë§‰ê¸°
    const formData = new FormData(this);
    fetch('/admin/dining/add', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      const diningId = data.dining_id;
      // diningFileForm ë‚´ì˜ input[name="dining_id"]ì— ì„¸íŒ…
      const fileFormDiningId = document.querySelector('#diningFileForm input[name="dining_id"]');
      if (fileFormDiningId) fileFormDiningId.value = diningId;
      saveCarouselImages(diningId, () => {
        window.location.href = '/admin/dining';
      });
    });
  });
}

// saveCarouselImages í•¨ìˆ˜ ì½œë°± ì§€ì›, diningId ëª…ì‹œì ìœ¼ë¡œ ë°›ìŒ
function saveCarouselImages(diningId, callback) {
  const items = document.querySelectorAll('.carousel-img-item');
  const uploadPromises = [];

  // íŒŒì¼ ì„ íƒ ì—¬ë¶€ í™•ì¸
  const hasMainFile = mainImageFile !== null;
  const hasLogoFile = logoImageFile !== null;
  const hasCarouselFiles = Array.from(items).some(item => item.file !== null);
  
  console.log('íŒŒì¼ ì„ íƒ ìƒíƒœ:', {
    mainFile: hasMainFile,
    logoFile: hasLogoFile,
    carouselFiles: hasCarouselFiles,
    totalItems: items.length
  });

  // ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ì„±ê³µ ì²˜ë¦¬
  if (!hasMainFile && !hasLogoFile && !hasCarouselFiles) {
    console.log('ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
    if (callback) callback();
    return;
  }

  // ë©”ì¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ
  if (mainImageFile) {
    console.log('ë©”ì¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘:', mainImageFile.name);
    const formData = new FormData();
    formData.append('dining_id', diningId);
    formData.append('main_image_file', mainImageFile);
    uploadPromises.push(
      fetch('/admin/dining/editFiles', {
        method: 'POST',
        body: formData
      })
      .then(res => {
        if (!res.ok) {
          return res.text().then(text => {
            console.error('ë©”ì¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', res.status, res.statusText, text);
            throw new Error('ë©”ì¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + text);
          });
        }
        return res.json();
      })
      .then(data => {
        console.log('ë©”ì¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:', data.imageUrl);
        document.querySelector('input[name="main_image_url"]').value = data.imageUrl;
      })
    );
  }

  // ë¡œê³  ì´ë¯¸ì§€ ì—…ë¡œë“œ
  if (logoImageFile) {
    console.log('ë¡œê³  ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘:', logoImageFile.name);
    const formData = new FormData();
    formData.append('dining_id', diningId);
    formData.append('logo_image_file', logoImageFile);
    uploadPromises.push(
      fetch('/admin/dining/editFiles', {
        method: 'POST',
        body: formData
      })
      .then(res => {
        if (!res.ok) {
          return res.text().then(text => {
            console.error('ë¡œê³  ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', res.status, res.statusText, text);
            throw new Error('ë¡œê³  ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + text);
          });
        }
        return res.json();
      })
      .then(data => {
        console.log('ë¡œê³  ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:', data.imageUrl);
        document.querySelector('input[name="logo_image_url"]').value = data.imageUrl;
      })
    );
  }

  // ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì¶”ê°€/êµì²´ëœ ê²ƒë§Œ)
  items.forEach((item, idx) => {
    const file = item.file;
    if (file) {
      console.log('ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œì‘:', file.name, 'ì¸ë±ìŠ¤:', idx + 1);
      const formData = new FormData();
      formData.append('dining_id', diningId);
      formData.append('carousel_image_file', file);
      formData.append('carousel_index', idx + 1);
      uploadPromises.push(
        fetch('/admin/dining/editFiles', {
          method: 'POST',
          body: formData
        })
        .then(res => {
          if (!res.ok) {
            return res.text().then(text => {
              console.error('ì¼€ëŸ¬ì…€ ì—…ë¡œë“œ ì‹¤íŒ¨:', res.status, res.statusText, text);
              throw new Error('ì¼€ëŸ¬ì…€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + text);
            });
          }
          return res.json();
        })
        .then(data => {
          console.log('ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:', data.imageUrl);
          const urlInput = item.querySelector('input[name="carousel_image_urls"]');
          if (urlInput) urlInput.value = data.imageUrl;
        })
      );
    }
  });

  // ëª¨ë“  ì—…ë¡œë“œê°€ ëë‚œ í›„ ìˆœì„œ ë™ê¸°í™”
  Promise.all(uploadPromises).then(() => {
    console.log('ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ');
    const orderedUrls = [];
    items.forEach(item => {
      const urlInput = item.querySelector('input[name="carousel_image_urls"]');
      if (urlInput && urlInput.value) {
        orderedUrls.push(urlInput.value);
      }
    });
    updateCarouselOrderOnServer(diningId, orderedUrls, () => {
      if (callback) callback();
    });
    mainImageFile = null;
    logoImageFile = null;
    items.forEach(item => { item.file = null; });
  }).catch((error) => {
    console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
  });
}

// updateCarouselOrderOnServer ì½œë°± ì§€ì›
function updateCarouselOrderOnServer(diningId, imageUrls, callback) {
  let bodyData = `dining_id=${encodeURIComponent(diningId)}`;
  
  // ì´ë¯¸ì§€ URLë“¤ ì¶”ê°€
  if (imageUrls && imageUrls.length > 0) {
    bodyData += '&' + imageUrls.map(url => `image_urls=${encodeURIComponent(url)}`).join('&');
  }
  
  // ì‚­ì œëœ ì´ë¯¸ì§€ URLë“¤ ì¶”ê°€
  if (deletedCarouselUrls && deletedCarouselUrls.length > 0) {
    bodyData += '&' + deletedCarouselUrls.map(url => `deleted_image_urls=${encodeURIComponent(url)}`).join('&');
  }
  
  console.log('ì¼€ëŸ¬ì…€ ìˆœì„œ ì—…ë°ì´íŠ¸ ìš”ì²­:', bodyData);
  
  fetch('/admin/dining/updateCarouselOrder', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: bodyData
  })
  .then(res => {
    if (res.ok) {
      console.log('ì¼€ëŸ¬ì…€ ìˆœì„œ ì—…ë°ì´íŠ¸ ì„±ê³µ');
      if (callback) callback();
    } else {
      console.error('ì¼€ëŸ¬ì…€ ìˆœì„œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', res.status, res.statusText);
      alert('ìˆœì„œ ì €ì¥ ì‹¤íŒ¨');
    }
  })
  .catch(error => {
    console.error('ì¼€ëŸ¬ì…€ ìˆœì„œ ì—…ë°ì´íŠ¸ ì—ëŸ¬:', error);
    alert('ìˆœì„œ ì €ì¥ ì‹¤íŒ¨');
  });
}
// ... ê¸°ì¡´ ì´ë¯¸ì§€/ì¼€ëŸ¬ì…€ JS ...

// 'ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ì¶”ê°€' ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒì°½ ì—´ê¸°
document.getElementById('add-carousel-btn').addEventListener('click', function() {
  document.getElementById('add-carousel-images').click();
});

// ì—¬ëŸ¬ ì¥ í•œ ë²ˆì— ì¶”ê°€ (input[type=file][multiple])
document.getElementById('add-carousel-images').addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    addCarouselImageWithFile(file);
  });
  // íŒŒì¼ ì„ íƒì°½ ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ê²Œ)
  e.target.value = '';
});

function addCarouselImageWithFile(file) {
  const carouselList = document.getElementById('carousel-img-list');
  const idx = carouselList.children.length;
  const div = document.createElement('div');
  div.className = 'carousel-img-item';
  div.style.position = 'relative';
  div.style.display = 'flex';
  div.style.alignItems = 'center';
  div.style.padding = '12px 0';
  div.style.borderBottom = '1px solid #e0e0e0';
  div.setAttribute('data-index', idx);
  // ë²ˆí˜¸(ìˆœë²ˆ)
  const numSpan = document.createElement('span');
  numSpan.style.width = '32px';
  numSpan.style.display = 'inline-block';
  numSpan.style.textAlign = 'center';
  numSpan.style.fontWeight = 'bold';
  numSpan.textContent = idx + 1;
  div.appendChild(numSpan);
  // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
  const img = document.createElement('img');
  img.style.maxWidth = '120px';
  img.style.border = '1px solid #ccc';
  img.style.borderRadius = '4px';
  img.style.margin = '0 16px';
  img.src = URL.createObjectURL(file);
  div.appendChild(img);
  // íŒŒì¼ input (hidden, êµì²´ìš©)
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.style.display = 'none';
  fileInput.onchange = function(e) {
    if (e.target.files[0]) {
      img.src = URL.createObjectURL(e.target.files[0]);
      div.file = e.target.files[0];
      hiddenInput.value = '';
    }
  };
  div.appendChild(fileInput);
  // hidden input (ì—…ë¡œë“œ í›„ ì„œë²„ì—ì„œ ë°˜í™˜ëœ URLë¡œ ê°±ì‹ )
  const hiddenInput = document.createElement('input');
  hiddenInput.type = 'hidden';
  hiddenInput.name = 'carousel_image_urls';
  div.appendChild(hiddenInput);
  // íŒŒì¼ ê°ì²´ ì €ì¥
  div.file = file;
  // ì‚­ì œ ë²„íŠ¼
  const delBtn = document.createElement('button');
  delBtn.type = 'button';
  delBtn.textContent = 'ì‚­ì œ';
  delBtn.className = 'action-btn delete-btn';
  delBtn.onclick = function() { div.parentNode.removeChild(div); renumberCarouselItems(); };
  div.appendChild(delBtn);
  // êµì²´ ë²„íŠ¼
  const replaceBtn = document.createElement('button');
  replaceBtn.type = 'button';
  replaceBtn.textContent = 'êµì²´';
  replaceBtn.className = 'action-btn replace-btn';
  replaceBtn.onclick = function() { fileInput.click(); };
  div.appendChild(replaceBtn);
  // ì¶”ê°€
  carouselList.appendChild(div);
  renumberCarouselItems();
}

// ì¼€ëŸ¬ì…€ ì´ë¯¸ì§€ ë²ˆí˜¸ ì¬ì •ë ¬
function renumberCarouselItems() {
  const items = document.querySelectorAll('.carousel-img-item');
  items.forEach((item, index) => {
    const numSpan = item.querySelector('span');
    if (numSpan) {
      numSpan.textContent = index + 1;
    }
  });
}

// íŒŒì¼ ì—…ë¡œë“œìš© ë³€ìˆ˜ ì„ ì–¸
let mainImageFile = null;
let logoImageFile = null;

// ë©”ì¸ ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
document.querySelector('input[name="main_image_file"]').addEventListener('change', function(e) {
  mainImageFile = e.target.files[0];
  const preview = document.getElementById('main-image-preview');
  if (mainImageFile) {
    preview.src = URL.createObjectURL(mainImageFile);
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
});

// ë¡œê³  ì´ë¯¸ì§€ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
document.querySelector('input[name="logo_image_file"]').addEventListener('change', function(e) {
  logoImageFile = e.target.files[0];
  const preview = document.getElementById('logo-image-preview');
  if (logoImageFile) {
    preview.src = URL.createObjectURL(logoImageFile);
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
});

const diningFileForm = document.getElementById('diningFileForm');
if (diningFileForm) {
  diningFileForm.addEventListener('submit', function(e) {
    e.preventDefault();

    // 1. ë‹¤ì´ë‹ ì •ë³´ ë¨¼ì € ì €ì¥
    const diningDataForm = document.getElementById('diningDataForm');
    const formData = new FormData(diningDataForm);

    fetch('/admin/dining/add', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      const diningId = data.dining_id;
      // hidden inputì— ì„¸íŒ…
      const fileFormDiningId = document.querySelector('#diningFileForm input[name="dining_id"]');
      if (fileFormDiningId) fileFormDiningId.value = diningId;
      // 2. ì´ë¯¸ì§€ ì—…ë¡œë“œ
      saveCarouselImages(diningId, () => {
        window.location.href = '/admin/dining';
      });
    });
  });
}
</script>
</body>
</html> 