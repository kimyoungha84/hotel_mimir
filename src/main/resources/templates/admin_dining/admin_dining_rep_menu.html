<!DOCTYPE html>
<html xmlns="http://www.thymeleaf.org" lang="ko">
<head>
<link rel="icon shortcut"  href="/admin_common_assets/common_img/mimir_favicon.ico"/>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<th:block th:replace="~{administrator/fragments/admin_header :: admin_header}"></th:block>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<th:block th:replace="~{administrator/fragments/admin_sidebar :: admin_sidebar}"></th:block>
<div id="body-pd" class="body-pd">
<hr/>
<main class="main-content" style="margin-right: 30px">
  <section class="dining-section">
    <h1>대표메뉴</h1>
    <!-- 테이블 -->
    <table class="dining-table">
      <thead>
        <tr>
          <th>번호</th>
          <th>메뉴명</th>
          <th>가격</th>
          <th>분류</th>
          <th style="text-align: center;">
            <button type="button" id="addMenuBtn" class="add-menu-btn">+</button>
          </th>
        </tr>
      </thead>
      <tbody th:fragment="rep_menu_list_fm" id="resultArea">
        <tr th:each="menu, stat : ${repMenuList}" th:attr="data-menu-id=${menu.menu_id}">
          <td th:text="${stat.count}"></td>
          <td th:text="${menu.menu_name}"></td>
          <td th:text="${#numbers.formatInteger(menu.price, 0, 'COMMA')}"></td>
          <td th:text="${menu.description}"></td>
          <td>
            <button type="button" class="edit-menu-btn" th:attr="data-menu-id=${menu.menu_id}, data-menu-name=${menu.menu_name}, data-description=${menu.description}, data-price=${menu.price}">수정</button>
          </td>
        </tr>
      </tbody>
    </table>
    <!-- 버튼 영역: 오른쪽 정렬 (삭제만) -->
    <div style="display: flex; justify-content: flex-end; gap: 16px; margin: 16px 0 0 0;">
      <a id="deleteBtn" href="#">
        <button type="button" class="delete-menu-btn">삭제</button>
      </a>
    </div>
    <!-- 페이지네이션 fragment -->
    <!-- <div th:replace="~{fragments/pagination :: pagination}"></div> -->
    
    <!-- 대표메뉴 수정 모달 팝업 -->
    <div id="editRepMenuModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
      <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
        <span class="close-button" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h2 style="margin-top: 0;">대표메뉴 수정</h2>
        <form id="editRepMenuForm">
          <input type="hidden" id="editDiningId" name="diningId">
          <input type="hidden" id="editMenuId" name="menuId">

          <div style="margin-bottom: 15px;">
            <label for="editMenuName" style="display: block; margin-bottom: 5px; font-weight: bold;">메뉴명:</label>
            <input type="text" id="editMenuName" name="menuName" style="width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label for="editDescription" style="display: block; margin-bottom: 5px; font-weight: bold;">분류:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <select id="editDescriptionSelect" style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="new">새로운 분류 입력</option>
                <option th:each="desc : ${descriptions}" th:value="${desc}" th:text="${desc}"></option>
              </select>
              <input type="text" id="editDescriptionInput" name="description" style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="새로운 분류명을 입력하세요">
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <label for="editPrice" style="display: block; margin-bottom: 5px; font-weight: bold;">가격:</label>
            <input type="text" id="editPrice" name="price" style="width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px;" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="숫자만 입력">
          </div>

          <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button type="submit" class="modal-submit-btn">수정</button>
            <button type="button" id="closeEditModalBtn" class="modal-close-btn">닫기</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- 대표메뉴 추가 모달 팝업 -->
    <div id="addRepMenuModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
      <div class="modal-content" style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
        <span class="close-button" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
        <h2 style="margin-top: 0;">대표메뉴 추가</h2>
        <form id="addRepMenuForm">
          <input type="hidden" id="addDiningId" name="diningId">

          <div style="margin-bottom: 15px;">
            <label for="addMenuName" style="display: block; margin-bottom: 5px; font-weight: bold;">메뉴명:</label>
            <input type="text" id="addMenuName" name="menuName" style="width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
          </div>

          <div style="margin-bottom: 15px;">
            <label for="addDescription" style="display: block; margin-bottom: 5px; font-weight: bold;">분류:</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <select id="addDescriptionSelect" style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="new">새로운 분류 입력</option>
                <option th:each="desc : ${descriptions}" th:value="${desc}" th:text="${desc}"></option>
              </select>
              <input type="text" id="addDescriptionInput" name="description" style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; display: none;" placeholder="새로운 분류명을 입력하세요">
            </div>
          </div>

          <div style="margin-bottom: 20px;">
            <label for="addPrice" style="display: block; margin-bottom: 5px; font-weight: bold;">가격:</label>
            <input type="text" id="addPrice" name="price" style="width: calc(100% - 22px); padding: 10px; border: 1px solid #ccc; border-radius: 4px;" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="숫자만 입력">
          </div>

          <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button type="submit" class="modal-submit-btn">추가</button>
            <button type="button" id="closeAddModalBtn" class="modal-close-btn">닫기</button>
          </div>
        </form>
      </div>
    </div>
    
    <style>
      .highlight-row {
        background-color: #d4cfc7 !important;
        transition: background 0.2s;
      }
      .dining-table tbody tr {
        cursor: pointer;
      }
      
      /* 버튼 스타일 개선 */
      .add-menu-btn {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(78, 205, 196, 0.2);
      }
      .add-menu-btn:hover {
        background: linear-gradient(135deg, #44a08d 0%, #3a8b7a 100%);
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 4px 16px rgba(78, 205, 196, 0.3);
      }
      .add-menu-btn:active {
        transform: translateY(0) scale(1.02);
      }
      
      .edit-menu-btn {
        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(33, 150, 243, 0.2);
      }
      .edit-menu-btn:hover {
        background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
      }
      .edit-menu-btn:active {
        transform: translateY(0);
      }
      
      .delete-menu-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.7rem 1rem;
        font-size: 1.1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2);
      }
      .delete-menu-btn:hover {
        background: linear-gradient(135deg, #ee5a52 0%, #d63031 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(255, 107, 107, 0.3);
      }
      .delete-menu-btn:active {
        transform: translateY(0);
      }
      
      .modal-submit-btn {
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.7rem 1rem;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(78, 205, 196, 0.2);
      }
      .modal-submit-btn:hover {
        background: linear-gradient(135deg, #44a08d 0%, #3a8b7a 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(78, 205, 196, 0.3);
      }
      .modal-submit-btn:active {
        transform: translateY(0);
      }
      
      .modal-close-btn {
        background: linear-gradient(135deg, #9e9e9e 0%, #757575 100%);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.7rem 1rem;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(158, 158, 158, 0.2);
      }
      .modal-close-btn:hover {
        background: linear-gradient(135deg, #757575 0%, #616161 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(158, 158, 158, 0.3);
      }
      .modal-close-btn:active {
        transform: translateY(0);
      }
    </style>
    <script th:inline="javascript">
    let selectedMenuId = null;
    let diningId = /*[[${diningId}]]*/ 0;
    let descriptions = /*[[${descriptions}]]*/ [];
    
    // 디버깅용 로그
    console.log('=== Frontend Debug Info ===');
    console.log('DiningId:', diningId);
    console.log('Descriptions:', descriptions);
    console.log('Descriptions length:', descriptions.length);
    console.log('===========================');
    
    // 분류 셀렉트 변경 이벤트 처리 함수
    function handleDescriptionSelectChange(selectId, inputId) {
      const select = document.getElementById(selectId);
      const input = document.getElementById(inputId);
      
      if (select.value === 'new') {
        input.style.display = 'block';
        input.focus();
        input.value = '';
      } else {
        input.style.display = 'none';
        input.value = select.value;
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      const tbody = document.getElementById('resultArea');
      tbody.addEventListener('click', function(e) {
        let tr = e.target.closest('tr');
        if (!tr || !tr.getAttribute('data-menu-id')) return;
        Array.from(tbody.querySelectorAll('tr')).forEach(r => r.classList.remove('highlight-row'));
        tr.classList.add('highlight-row');
        window.selectedMenuId = tr.getAttribute('data-menu-id');
        console.log('row click:', window.selectedMenuId);
      });
      
      // 삭제 버튼 이벤트
      document.getElementById('deleteBtn').addEventListener('click', function(e) {
        e.preventDefault();
        if (!window.selectedMenuId) {
          alert('레코드를 선택하세요.');
          return;
        }
        if (!confirm('정말 삭제하시겠습니까?')) {
          return;
        }
        axios.delete('/api/admin/repMenu/' + window.selectedMenuId)
          .then(function(response) {
            if (response.data.success) {
              alert('삭제가 완료되었습니다.');
              location.reload();
            } else {
              alert('삭제에 실패했습니다: ' + response.data.message);
            }
            window.selectedMenuId = null;
          })
          .catch(function(error) {
            alert('삭제에 실패했습니다. 참조된 데이터가 있을 수 있습니다.');
            console.error(error);
          });
      });
      
      // 수정 버튼 클릭 이벤트 (테이블 내 각 행의 수정 버튼)
      document.querySelectorAll('.edit-menu-btn').forEach(button => {
        button.addEventListener('click', function(e) {
          e.preventDefault();
          const menuId = this.getAttribute('data-menu-id');
          const menuName = this.getAttribute('data-menu-name');
          const description = this.getAttribute('data-description');
          const price = this.getAttribute('data-price');

          // 팝업 필드에 데이터 채우기
          document.getElementById('editDiningId').value = diningId;
          document.getElementById('editMenuId').value = menuId;
          document.getElementById('editMenuName').value = menuName;
          document.getElementById('editPrice').value = price;

          // 분류 설정
          const editSelect = document.getElementById('editDescriptionSelect');
          const editInput = document.getElementById('editDescriptionInput');
          
          // 기존 분류 목록에 있는지 확인
          const existingDescriptions = Array.from(editSelect.options).map(option => option.value);
          if (existingDescriptions.includes(description)) {
            editSelect.value = description;
            editInput.style.display = 'none';
            editInput.value = description;
          } else {
            editSelect.value = 'new';
            editInput.style.display = 'block';
            editInput.value = description;
          }

          // 모달 열기
          document.getElementById('editRepMenuModal').style.display = 'block';
        });
      });

      // 수정 모달의 분류 셀렉트 변경 이벤트
      document.getElementById('editDescriptionSelect').addEventListener('change', function() {
        handleDescriptionSelectChange('editDescriptionSelect', 'editDescriptionInput');
      });

      // 추가 모달의 분류 셀렉트 변경 이벤트
      document.getElementById('addDescriptionSelect').addEventListener('change', function() {
        handleDescriptionSelectChange('addDescriptionSelect', 'addDescriptionInput');
      });

      // 모달 닫기 버튼 이벤트
      document.getElementById('closeEditModalBtn').addEventListener('click', function() {
        document.getElementById('editRepMenuModal').style.display = 'none';
      });

      // 모달 외부 클릭 시 닫기
      window.addEventListener('click', function(event) {
        const addModal = document.getElementById('addRepMenuModal');
        const editModal = document.getElementById('editRepMenuModal');
        if (event.target == addModal) {
          addModal.style.display = 'none';
        }
        if (event.target == editModal) {
          editModal.style.display = 'none';
        }
      });

      // X 버튼 클릭 이벤트 (수정 모달)
      document.querySelector('#editRepMenuModal .close-button').addEventListener('click', function() {
        document.getElementById('editRepMenuModal').style.display = 'none';
      });

      // X 버튼 클릭 이벤트 (추가 모달)
      document.querySelector('#addRepMenuModal .close-button').addEventListener('click', function() {
        document.getElementById('addRepMenuModal').style.display = 'none';
      });

      // 팝업 내 수정 폼 제출 이벤트
      document.getElementById('editRepMenuForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // 유효성검증
        const menuName = document.getElementById('editMenuName').value.trim();
        const descriptionSelect = document.getElementById('editDescriptionSelect');
        const descriptionInput = document.getElementById('editDescriptionInput');
        const price = document.getElementById('editPrice').value.trim();

        if (!menuName) {
          alert('메뉴명을 입력해주세요.');
          document.getElementById('editMenuName').focus();
          return;
        }

        let description = '';
        if (descriptionSelect.value === 'new') {
          description = descriptionInput.value.trim();
          if (!description) {
            alert('새로운 분류명을 입력해주세요.');
            descriptionInput.focus();
            return;
          }
        } else {
          description = descriptionSelect.value;
          if (!description) {
            alert('분류를 선택해주세요.');
            descriptionSelect.focus();
            return;
          }
        }

        if (!price) {
          alert('가격을 입력해주세요.');
          document.getElementById('editPrice').focus();
          return;
        }

        if (price < 0) {
          alert('가격은 0 이상이어야 합니다.');
          document.getElementById('editPrice').focus();
          return;
        }

        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
          data[key] = value;
        });

        axios.put('/api/admin/repMenu/update', data)
          .then(response => {
            if (response.data.success) {
              alert('대표메뉴가 성공적으로 수정되었습니다.');
              document.getElementById('editRepMenuModal').style.display = 'none';
              location.reload();
            } else {
              alert('대표메뉴 수정에 실패했습니다: ' + response.data.message);
            }
          })
          .catch(error => {
            console.error('Error updating rep menu:', error);
            alert('대표메뉴 수정 중 오류가 발생했습니다.');
          });
      });

      // 추가 버튼 클릭 이벤트
      document.getElementById('addMenuBtn').addEventListener('click', function() {
        // 추가 모달 필드 초기화
        document.getElementById('addDiningId').value = diningId;
        document.getElementById('addMenuName').value = '';
        document.getElementById('addDescriptionSelect').value = '';
        document.getElementById('addDescriptionInput').value = '';
        document.getElementById('addDescriptionInput').style.display = 'none';
        document.getElementById('addPrice').value = '';

        // 추가 모달 열기
        document.getElementById('addRepMenuModal').style.display = 'block';
      });

      // 추가 모달 닫기 버튼 이벤트
      document.getElementById('closeAddModalBtn').addEventListener('click', function() {
        document.getElementById('addRepMenuModal').style.display = 'none';
      });

      // 추가 모달 폼 제출 이벤트
      document.getElementById('addRepMenuForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // 유효성검증
        const menuName = document.getElementById('addMenuName').value.trim();
        const descriptionSelect = document.getElementById('addDescriptionSelect');
        const descriptionInput = document.getElementById('addDescriptionInput');
        const price = document.getElementById('addPrice').value.trim();

        if (!menuName) {
          alert('메뉴명을 입력해주세요.');
          document.getElementById('addMenuName').focus();
          return;
        }

        let description = '';
        if (descriptionSelect.value === 'new') {
          description = descriptionInput.value.trim();
          if (!description) {
            alert('새로운 분류명을 입력해주세요.');
            descriptionInput.focus();
            return;
          }
        } else {
          description = descriptionSelect.value;
          if (!description) {
            alert('분류를 선택해주세요.');
            descriptionSelect.focus();
            return;
          }
        }

        if (!price) {
          alert('가격을 입력해주세요.');
          document.getElementById('addPrice').focus();
          return;
        }

        if (price < 0) {
          alert('가격은 0 이상이어야 합니다.');
          document.getElementById('addPrice').focus();
          return;
        }

        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
          data[key] = value;
        });

        axios.post('/api/admin/repMenu/add', data)
          .then(response => {
            if (response.data.success) {
              alert('대표메뉴가 성공적으로 추가되었습니다.');
              document.getElementById('addRepMenuModal').style.display = 'none';
              location.reload();
            } else {
              alert('대표메뉴 추가에 실패했습니다: ' + response.data.message);
            }
          })
          .catch(error => {
            console.error('Error adding rep menu:', error);
            alert('대표메뉴 추가 중 오류가 발생했습니다.');
          });
      });
    });
    </script>
  </section>
</main>
</div>
</body>
</html> 