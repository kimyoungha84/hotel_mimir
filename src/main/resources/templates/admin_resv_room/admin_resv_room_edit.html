<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <link rel="stylesheet" th:href="@{/css/admin_resv_room/admin_resv_room_edit.css}" />
  <link rel="icon shortcut"  href="/admin_common_assets/common_img/mimir_favicon.ico"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
  <!-- jquery CDN -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>

  <style>
  </style>
<th:block th:replace="~{/administrator/fragments/admin_header :: admin_header}"></th:block>
</head>
<body>
<th:block th:replace="~{/administrator/fragments/admin_sidebar :: admin_sidebar}"></th:block>
<div id="body-pd" class="body-pd">
<div class="table-section">

<div class="table-section">
  <h2 class="h2Title">객실 예약 수정</h2>

  <form th:action="@{/admin/resvModifyProcess}" method="post">
  <input type="hidden" name="resvId" th:value="${resv.resvId}" />
  <input type="hidden" name="isMember" th:value="${resv.isMember}" />
  <input type="hidden" name="userNum" th:value="${resv.userNum}" />
  <input type="hidden" id="roomCapacity" th:value="${capacity}" />
    <div class="form-box">
    <table class="detail-table">
      <tr>
        <td>예약번호</td>
        <td  th:text="${resv.resvId}">20250617</td>
      </tr>
      <tr>
  <td>고객명</td>
  
    <th:block th:if="${resv.isMember}">
     <td th:text="${resv.userName}"></td>
    </th:block>
    <th:block th:unless="${resv.isMember}">
      <td><input type="text" name="userName" th:value="${resv.userName}" style="width: 200px; text-align: center;"/></td>
    </th:block>
	</tr>
	<tr>
  <td>연락처</td>
    <th:block th:if="${resv.isMember}">
      <td th:text="${resv.userTel}"></td>
    </th:block>
    <th:block th:unless="${resv.isMember}">
      <td> <input type="text" name="userTel" id="userTel" th:value="${resv.userTel}" style="width: 200px; text-align: center;"></td>
    </th:block>
</tr>

<tr>
  <td style="padding: 10px;"><label for="email">이메일</label></td>

  <td colspan="4" style="padding: 10px;">
    <th:block th:if="${resv.isMember}">
      <span th:text="${resv.userEmail}"></span>
    </th:block>
    <th:block th:unless="${resv.isMember}">
      <input type="text" id="email" name="userEmail"
             th:value="${#strings.substringBefore(resv.userEmail, '@')}" style="width: 150px; margin-right: 10px; text-align: center;">

      <label for="domain" style="margin-right: 6px;">도메인</label>
      <select id="domain" name="userDomain" style="width: 150px; margin-right: 10px;">
        <option value="">도메인 선택</option>
        <option value="@naver.com"
          th:selected="${#strings.substringAfter(resv.userEmail, '@')} == 'naver.com'">@naver.com</option>
        <option value="@gmail.com"
          th:selected="${#strings.substringAfter(resv.userEmail, '@')} == 'gmail.com'">@gmail.com</option>
        <option value="@hanmail.net"
          th:selected="${#strings.substringAfter(resv.userEmail, '@')} == 'hanmail.net'">@hanmail.net</option>
        <option value="custom"
          id="customOption"
          th:selected="${#lists.contains({'naver.com','gmail.com','hanmail.net'}, #strings.substringAfter(resv.userEmail, '@')) == false}">직접 입력</option>
      </select>
      <input type="text" id="custom-domain" name="customDomain"
             th:value="${#lists.contains({'naver.com','gmail.com','hanmail.net'}, #strings.substringAfter(resv.userEmail, '@')) ? '' : #strings.substringAfter(resv.userEmail, '@')}"
             placeholder="도메인을 입력하세요" style="width: 180px; text-align: center;">
    </th:block>
  </td>
</tr>


      <tr>
        <td>룸 종류(호실)</td>
        <td  th:text="|${resv.typeName}(${resv.roomId})|">프리미어룸(708)</td>
      </tr>
      <tr>
        <td>결제 금액</td>
        <td  th:text="'₩' + ${#numbers.formatInteger(resv.paymentPrice, 3, 'COMMA')}"></td>
      </tr>
      <tr>
        <td>결제 수단(결제 상태)</td>
        <td  th:text="|${resv.paymentType}(${resv.paymentStatus})|"></td>
      </tr>
      <tr>
        <td>체크인</td>
        <td  th:text="${resv.checkinDate}">2025.08.27(수)</td>
      </tr>
      <tr>
        <td>체크아웃</td>
        <td  th:text="${resv.checkoutDate}">2025.08.29(금)</td>
      </tr>
      <tr>
        <td>인원 수</td>
        <td>
        <label>성인: </label><input type="number" name="numGuestsAdult" th:value="${resv.numGuestsAdult}" style="width: 100px; text-align: center;"> 
        <label>아동: </label><input type="number" name="numGuestsChild" th:value="${resv.numGuestsChild}" style="width: 100px; text-align: center;">
        </td>
      </tr>
      <tr>
        <td>예약상태</td>
        <td>
  			<select name="status" style="width: 150px; text-align: center; ">
    			<option value="예약완료" th:selected="${resv.status == '예약완료'}">예약완료</option>
    			<option value="예약취소" th:selected="${resv.status == '예약취소'}">예약취소</option>
    			<option value="체크인" th:selected="${resv.status == '체크인'}">체크인</option>
    			<option value="체크아웃" th:selected="${resv.status == '체크아웃'}">체크아웃</option>
  			</select>
		</td>
      </tr>
      <tr>
        <td>회원/비회원</td>
        <td th:text="${resv.userName != null} ? (${resv.isMember != null and resv.isMember} ? '회원' : '비회원') : 'N/A'"></td>
      </tr>
        
      <tr>
        <td>요청사항</td>
        <td> <input type="text" name="requestMsg" th:value="${resv.requestMsg}"></td>
      </tr>
    </table>

      <div class="form-actions">
        <button type="submit" class="btn-save">수정</button>
        <button type="button" class="btn-cancel" onclick="history.back()">취소</button>
      </div>
    </div>
  </form>
  
  </div>
  </div>
  </div>

<script>
$(function(){
	  $('#custom-domain').hide(); // 기본은 숨김

    $('#domain').change(function () {
      if ($(this).val() === 'custom') {
        $('#custom-domain').show().focus();
      } else {
        $('#custom-domain').hide().val('');
      }
    });
});
</script>
<script th:inline="javascript">
  /*<![CDATA[*/
  var msg = /*[[${msg}]]*/ null;
  if (msg !== null && msg !== '') {
    alert(msg);
  }
  /*]]>*/
</script>

<script>
$(function () {
	  const roomCapacity = parseInt($('#roomCapacity').val(), 10);

	  function validateGuests(showAlert = true) {
	    let adults = parseInt($('input[name="numGuestsAdult"]').val(), 10);
	    let children = parseInt($('input[name="numGuestsChild"]').val(), 10);
	    let valid = true;

	    if (isNaN(adults) || adults < 1) {
	      if (showAlert) alert('성인은 1명 이상이어야 합니다.');
	      $('input[name="numGuestsAdult"]').val(1);
	      adults = 1;
	      valid = false;
	    }

	    if (isNaN(children) || children < 0) {
	      if (showAlert) alert('아동 인원은 0명 이상이어야 합니다.');
	      $('input[name="numGuestsChild"]').val(0);
	      children = 0;
	      valid = false;
	    }

	    const totalGuests = adults + children;

	    if (totalGuests > roomCapacity) {
	      if (showAlert) alert(`총 인원 수는 객실 최대 수용 인원인 ${roomCapacity}명을 초과할 수 없습니다.`);

	      // 초과한 입력을 한 항목만 줄여줌
	      const inputName = $(document.activeElement).attr("name");
	      if (inputName === "numGuestsAdult") {
	        $('input[name="numGuestsAdult"]').val(adults - 1);
	      } else if (inputName === "numGuestsChild") {
	        $('input[name="numGuestsChild"]').val(children - 1);
	      }

	      valid = false;
	    }

	    return valid;
	  }

	  // input 변경 시마다 검증
	  $('input[name="numGuestsAdult"], input[name="numGuestsChild"]').on('input', validateGuests);

	  // 폼 제출 시 검증해서 유효하지 않으면 제출 막기
	  $('form').on('submit', function (e) {
	    if (!validateGuests()) {
	      e.preventDefault();
	    }
	  });

	  // 초기 유효성 검증
	  validateGuests();

	  // 이메일 도메인 관련
	  $('#custom-domain').hide();
	  $('#domain').change(function () {
	    if ($(this).val() === 'custom') {
	      $('#custom-domain').show().focus();
	    } else {
	      $('#custom-domain').hide().val('');
	    }
	  });
	});


const phoneInput = document.getElementById('userTel');
phoneInput.addEventListener('input', function (e) {
  let value = e.target.value.replace(/\D/g, '');
  if (value.length <= 3) {
    value = value;
  } else if (value.length <= 7) {
    value = value.slice(0, 3) + '-' + value.slice(3);
  } else {
    value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
  }
  e.target.value = value;
});

</script>



</body>
</html>
