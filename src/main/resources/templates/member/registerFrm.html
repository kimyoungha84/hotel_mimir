<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:class="sub-page">
<head>
    <meta charset="UTF-8">
    <title>회원가입</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <style>
    	body {
  	 		padding-top: 130px;
  		}
    	
        .form-container {
            max-width: 500px;
            margin: 50px auto;
            padding: 30px;
            background: #fff;
            border-radius: 10px;
        }
        .form-title {
            text-align: center;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>

<!-- Header -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="container">
    <div class="form-container shadow">
        <h3 class="form-title">회원가입</h3>

        <form th:action="@{/member/register}" th:object="${memberDTO}" method="post" onsubmit="return validateForm()">

            <!-- 이름 -->
            <div class="mb-3">
                <label for="user_name" class="form-label">이름</label>
                <input type="text" th:field="*{user_name}" class="form-control" placeholder="이름 입력" />
                <div class="text-danger" th:errors="*{user_name}"></div>
            </div>
			
			<!-- 이메일(아이디) -->
			<div class="mb-3">
				<label for="email_id" class="form-label">이메일 아이디</label>
				<div class="input-group">
					<input type="email" th:field="*{email_id}" id="email_id"
							class="form-control" placeholder="example@test.com" readonly />
					<button class="btn btn-outline-secondary" type="button" id="email_check_btn"
							onclick="openEmailPopup()">중복확인</button>
				</div>
					<div class="text-danger" th:errors="*{email_id}"></div>
			</div>
			
				<!-- 이메일 인증 관련 히든 필드 -->
				<input type="hidden" name="token" id="auth_token" />
				<input type="hidden" th:field="*{email_auth}" />
                <input type="hidden" id="email_verified" value="false" />


				<!-- 비밀번호 -->
            <div class="mb-3">
                <label for="password" class="form-label">비밀번호</label>
                <input type="password" th:field="*{password}" id="password" class="form-control" placeholder="비밀번호 입력" />
                <div class="text-danger" th:errors="*{password}"></div>
            </div>

            <!-- 비밀번호 확인 -->
            <div class="mb-3">
                <input type="password" id="confirmPassword" class="form-control" placeholder="비밀번호 재입력" />
                <div id="pwCheckMessage" class="text-danger"></div>
            </div>

			<!-- 성별 -->
			<div class="mb-3">
				<label class="form-label d-block">성별</label>
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" th:field="*{gender}" id="genderMale" value="M" /> 
					<label class="form-check-label" for="genderMale">남성</label>
				</div>
				<div class="form-check form-check-inline">
					<input class="form-check-input" type="radio" th:field="*{gender}" id="genderFemale" value="F" />
					<label class="form-check-label" for="genderFemale">여성</label>
				</div>
				<div class="text-danger" th:errors="*{gender}"></div>
			</div>

				<!-- 전화번호 -->
            <div class="mb-3">
                <label for="tel" class="form-label">전화번호</label>
                <input type="text" th:field="*{tel}" class="form-control" placeholder="예: 01012345678" />
                <div class="text-danger" th:errors="*{tel}"></div>
            </div>
            

            <!-- 생년월일 -->
            <div class="mb-3">
                <label for="birth_date" class="form-label">생년월일</label>
                <input type="date" th:field="*{birth_date}" class="form-control" />
                <div class="text-danger" th:errors="*{birth_date}"></div>
            </div>

            <button type="submit" class="btn btn-dark w-100">회원가입</button>
        </form>
    </div>
</div>

<script type="text/javascript">
    function openEmailPopup() {
        window.open('/member/email-popup', 'emailPopup', 'width=500,height=450,left=200,top=150');
    }

    // 이메일 인증 완료 시 팝업창에서 호출할 함수
    function onEmailVerified(email, token, authCode) {
        document.getElementById("email_id").value = email;
        document.getElementById("auth_token").value = token;
        document.getElementsByName("email_auth")[0].value = authCode;
        document.getElementById("email_verified").value = "true";

        const emailCheckBtn = document.getElementById("email_check_btn");
        emailCheckBtn.textContent = "인증 완료";
        emailCheckBtn.disabled = true;
    }

    // 비밀번호 일치 확인
    const password = document.getElementById("password");
    const confirmPassword = document.getElementById("confirmPassword");
    const pwCheckMessage = document.getElementById("pwCheckMessage");

    function checkPasswordMatch() {
        if (password.value !== "" && confirmPassword.value !== "") {
            if (password.value === confirmPassword.value) {
                pwCheckMessage.textContent = "비밀번호가 일치합니다.";
                pwCheckMessage.className = "text-success";
            } else {
                pwCheckMessage.textContent = "비밀번호가 일치하지 않습니다.";
                pwCheckMessage.className = "text-danger";
            }
        } else {
            pwCheckMessage.textContent = "";
        }
    }

    password.addEventListener("keyup", checkPasswordMatch);
    confirmPassword.addEventListener("keyup", checkPasswordMatch);

    // 폼 제출 전 유효성 검증
    function validateForm() {
        const isEmailVerified = document.getElementById("email_verified").value === "true";
        if (!isEmailVerified) {
            alert("이메일 인증을 완료해주세요.");
            return false;
        }

        if (password.value !== confirmPassword.value) {
            alert("비밀번호가 일치하지 않습니다.");
            return false;
        }
        
        return true;
    }
</script>
</body>
</html>""