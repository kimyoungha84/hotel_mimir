<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:class="sub-page">
<head>
    <meta charset="UTF-8">
    <title>아이디 찾기</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            padding-top: 130px;
        }
        .find-id-container {
            max-width: 400px;
            margin: 80px auto;
            padding: 40px;
        }
    </style>
</head>
<body>

<!-- Header -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="container">
    <div class="find-id-container">
        <h3 class="text-center mb-4">아이디 찾기</h3>

        <form id="findIdForm">
            <div class="mb-3">
                <label for="name" class="form-label">이름</label>
                <input type="text" class="form-control" id="name" name="name" placeholder="가입 시 입력한 이름" required>
            </div>

            <div class="mb-3">
                <label for="email" class="form-label">이메일</label>
                <div class="input-group">
                    <input type="email" class="form-control" id="email" name="email" placeholder="가입 시 입력한 이메일" required>
                    <button class="btn btn-outline-secondary" type="button" id="sendAuthCodeBtn">인증번호 전송</button>
                </div>
            </div>

            <div class="mb-3" id="authCodeGroup" style="display: none;">
                <label for="authCode" class="form-label">인증번호</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="authCode" name="authCode" placeholder="인증번호 입력">
                    <button class="btn btn-outline-primary" type="button" id="verifyAuthCodeBtn">인증 확인</button>
                </div>
                <div id="timer" class="form-text"></div>
            </div>
            
            <div id="message" class="mt-3"></div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function() {
        let interval;
        let token;

        $("#sendAuthCodeBtn").click(function() {
            const name = $("#name").val();
            const email = $("#email").val();

            if (!name || !email) {
                alert("이름과 이메일을 모두 입력해주세요.");
                return;
            }

            $.ajax({
                url: "/member/send-auth-code-find-id",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ name: name, email: email }),
                success: function(response) {
                    if (response.token) {
                        token = response.token;
                        alert("인증번호가 발송되었습니다.");
                        $("#authCodeGroup").show();
                        startTimer(180); 
                    } else {
                        alert(response.error);
                    }
                },
                error: function() {
                    alert("인증번호 발송에 실패했습니다.");
                }
            });
        });

        $("#verifyAuthCodeBtn").click(function() {
            const email = $("#email").val();
            const code = $("#authCode").val();

            $.ajax({
                url: "/member/verify-auth-code-find-id",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ email: email, code: code, token: token }),
                success: function(response) {
                    if (response.success) {
                        window.location.href = "/member/find-id-result?email=" + encodeURIComponent(email);
                    } else {
                        alert("인증번호가 일치하지 않습니다.");
                    }
                },
                error: function() {
                    alert("인증 확인에 실패했습니다.");
                }
            });
        });

        function startTimer(duration) {
            let timer = duration, minutes, seconds;
            clearInterval(interval);
            interval = setInterval(function() {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                $("#timer").text(minutes + ":" + seconds);

                if (--timer < 0) {
                    clearInterval(interval);
                    $("#timer").text("인증 시간이 만료되었습니다.");
                    $("#sendAuthCodeBtn").prop("disabled", false);
                }
            }, 1000);
        }
    });
</script>

</body>
</html>
