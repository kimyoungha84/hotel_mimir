<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>이메일 인증</title>
    <link rel="stylesheet" 
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <style>
        body {
            background-color: #fff;
        }

        .email-popup-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
        }

        .btn-black {
            background-color: #000;
            color: #fff;
        }

        .btn-black:hover {
            background-color: #333;
            color: #fff;
        }

        .text-small {
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<div class="email-popup-container">
    <h4 class="text-center mb-4">이메일 인증</h4>

    <div class="mb-3">
        <input type="email" id="popup_email" class="form-control" placeholder="이메일 입력" required />
    </div>

    <button type="button" class="btn btn-black w-100 mb-3" onclick="sendAuthCode()">인증번호 발송</button>

    <div class="mb-3">
        <input type="text" id="auth_code" class="form-control" placeholder="인증번호 입력" required />
    </div>

    <button type="button" class="btn btn-success w-100" onclick="confirmAuthCode()">확인</button>

    <div id="popupMessage" class="mt-3 text-success text-center text-small"></div>
</div>

<script th:inline="javascript">
    let jwtToken = "";

    // 이메일 형식 유효성 검사를 위한 정규식
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    function sendAuthCode() {
        const email = document.getElementById("popup_email").value.trim();
        
        if (!email) {
            alert("이메일을 입력해주세요.");
            return;
        }
        
        if (!emailRegex.test(email)) {
            alert("유효한 이메일 주소를 입력해주세요.");
            return;
        }

        fetch("/member/send-auth-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email })
        })
        .then(res => {
            if (!res.ok) {
                throw new Error("인증번호 발송에 실패했습니다. 이메일을 확인해주세요.");
            }
            return res.json();
        })
        .then(data => {
            if(data.error) {
                alert(data.error);
                return;
            }
            jwtToken = data.token;
            alert("인증번호가 발송되었습니다.");
        })
        .catch(error => {
            alert(error.message);
        });
    }

    function confirmAuthCode() {
        const email = document.getElementById("popup_email").value.trim();
        const code = document.getElementById("auth_code").value.trim();

        if (!email) {
            alert("이메일을 입력해주세요.");
            return;
        }
        
        if (!emailRegex.test(email)) {
            alert("유효한 이메일 주소를 입력해주세요.");
            return;
        }

        if (!code) {
            alert("인증번호를 입력해주세요.");
            return;
        }

        fetch("/member/verify-auth-code", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, code, token: jwtToken })
        })
        .then(res => res.text())
        .then(result => {
            if (result === "success") {
                alert("인증에 성공하였습니다.");

                try {
                    window.opener.onEmailVerified(email, jwtToken, code);
                } catch (e) {
                    console.error("부모 창에 값을 전달할 수 없습니다.", e);
                }

                window.close();
            } else {
                alert("인증번호가 일치하지 않거나 유효하지 않습니다.");
            }
        })
        .catch(error => {
             alert("인증 확인 중 오류가 발생했습니다.");
        });
    }
</script>
</body>
</html>