<div th:fragment="filter(filter)"> 
  <style>
    /* ìœ ë‹ˆí¬í•œ í´ë˜ìŠ¤ë¡œ ìŠ¤íƒ€ì¼ ì§€ì • */
    .filter-form {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
      margin-top: 10px;
      margin-bottom: 30px;
    }

    .filter-date-picker {
      display: flex;
      flex: 1;
      gap: 10px;
    }

    .filter-date-picker input[type="date"] {
      border: 1px solid #ddd;
      padding: 5px;
      border-radius: 4px;
      width: 150px;  /* í¬ê¸° ì¤„ì´ê¸° */
      font-size: 14px;
    }

    .filter-right-section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-right: 30px;
    }

    .filter-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-select-box {
      padding: 5px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 150px;
    }

    .filter-search-text {
      flex: 1;
    }

    .filter-input {
      width: 200px;  /* ê²€ìƒ‰ì°½ í¬ê¸° í‚¤ìš°ê¸° */
      padding: 8px 12px;  /* í…ìŠ¤íŠ¸ ì…ë ¥ íŒ¨ë”© ì¶”ê°€ */
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      height: 40px;
    }

    .filter-search-btn {
      padding: 8px 15px;  /* ë²„íŠ¼ í¬ê¸° ì•½ê°„ í‚¤ìš°ê¸° */
      font-size: 14px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .filter-search-btn:hover {
      background-color: #45a049;
    }

    .filter-search-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .error-message {
      color: #f44336;
      font-size: 14px;
      margin-top: 10px;
      display: none;
    }

    /* ëª¨ë°”ì¼ ëŒ€ì‘ */
    @media (max-width: 768px) {
      .filter-form {
        flex-direction: column;
        gap: 15px;
      }

      .filter-right-section {
        flex-direction: column;
        align-items: flex-start;
      }

      .filter-search-text input,
      .filter-select-box {
        width: 100%;
      }

      .filter-input {
        width: 100%;  /* ëª¨ë°”ì¼ì—ì„œëŠ” ì „ì²´ í¬ê¸°ë¡œ í™•ì¥ */
      }
    }
  </style>

  <form id="searchApiForm" class="filter-form">
    <input type="hidden" name="filterType" th:value="${filterType}" />
    
    <!-- ì™¼ìª½: Date Picker -->
    <div th:if="${filter.showDatePicker}" class="filter-date-picker">
      <input type="hidden" name="dateName" th:value="${filter.filteringDateName}" />
      <input type="date" name="startDate" th:value="${param.startDate}" />
      <input type="date" name="endDate" th:value="${param.endDate}" />
    </div>
    
<!-- ğŸ”¹ ì²´í¬ë°•ìŠ¤ í•„í„° ì˜µì…˜ -->
<div th:if="${filter.checkboxOptions != null and #lists.size(filter.checkboxOptions) > 0}" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
  <div th:each="cb : ${filter.checkboxOptions}" class="filter-selector">
    <label>
      <!-- hidden input: ë¯¸ì²´í¬ ì‹œ 'off'ë¡œ ê³ ì • -->
      <input type="hidden" th:name="${cb.name}" value="off" />
      <input type="checkbox" th:name="${cb.name}" value="on"
        th:checked="${param[cb.name]} == 'on'" />
      <span th:text="${cb.label}"></span>
    </label>
  </div>
</div>

<!-- ğŸ”¹ ë¼ë²¨ + ì…€ë ‰í„° (ê°€ë¡œ ë°°ì¹˜) -->
<div th:if="${filter.labelSelectorOptions != null and #lists.size(filter.labelSelectorOptions) > 0}" 
     style="display: flex; flex-wrap: wrap; gap: 10px;">
  <div th:each="selector : ${filter.labelSelectorOptions}" class="filter-selector">
    <label th:text="${selector.label}"></label>
    <select class="filter-select-box" th:name="${selector.selectorName}">
      <option th:each="opt : ${selector.options}" 
              th:value="${opt.label}" 
              th:text="${opt.label}">ì˜µì…˜</option>
    </select>
  </div>
</div>

    <!-- ì˜¤ë¥¸ìª½: ì½¤ë³´ë°•ìŠ¤, í…ìŠ¤íŠ¸ ì…ë ¥, ê²€ìƒ‰ ë²„íŠ¼ -->
    <div class="filter-right-section">
      <!-- ì…€ë ‰í„°ê°€ 1ê°œì¼ ê²½ìš°, ë¼ë²¨ë§Œ í‘œì‹œ -->
      <div th:if="${filter.showSelector}" class="filter-selector">
      	<input type="hidden" name="searchType" th:value="${filter.selectOptions[0].value}" />
        <span th:if="${#lists.size(filter.selectOptions) == 1}" th:text="${filter.selectOptions[0].label}"></span>
        <!-- ì…€ë ‰í„°ê°€ 2ê°œ ì´ìƒì¼ ê²½ìš°ì—ë§Œ select box í‘œì‹œ -->
        <select th:if="${#lists.size(filter.selectOptions) > 1}" name="searchType" class="filter-select-box">
          <option th:each="opt : ${filter.selectOptions}" 
                  th:value="${opt.value}" th:text="${opt.label}">ê²€ìƒ‰</option>
        </select>
      </div>

      <!-- í…ìŠ¤íŠ¸ ì…ë ¥ -->
      <div th:if="${filter.showSearchText}" class="filter-search-text">
        <input type="text" name="searchKeyword" th:value="${param.searchKeyword}" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" class="filter-input" />
      </div>

      <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
      <button type="button" id="searchApiBtn" class="filter-search-btn">ê²€ìƒ‰</button>
      <button type="button" id="resetFiltersBtn" class="filter-search-btn" style="background-color: #f44336;">ì´ˆê¸°í™”</button>
    </div>

    <!-- ìˆ¨ê²¨ì§„ í•„ë“œë“¤ -->
    <input type="hidden" name="currentPage" th:value="${currentPage}" />
    <input type="hidden" name="pageSize" th:value="${pageSize}" />
    
    <!-- ì—ëŸ¬ ë©”ì‹œì§€ ì˜ì—­ -->
    <div id="errorMessage" class="error-message"></div>
    
  </form>

<script th:inline="javascript">
(function () {
  const $btn = document.getElementById("searchApiBtn");
  const $form = document.getElementById("searchApiForm");
  const $errorMessage = document.getElementById("errorMessage");
  let isSearching = false;

  function showError(message) {
    $errorMessage.textContent = message;
    $errorMessage.style.display = 'block';
    setTimeout(() => {
      $errorMessage.style.display = 'none';
    }, 5000);
  }

  function setLoading(loading) {
    isSearching = loading;
    $btn.disabled = loading;
    $form.classList.toggle('loading', loading);
    $btn.textContent = loading ? 'ê²€ìƒ‰ ì¤‘...' : 'ê²€ìƒ‰';
  }

  async function performSearch() {
    if (isSearching) return;
    try {
      setLoading(true);
      $errorMessage.style.display = 'none';
      const params = new URLSearchParams(new FormData($form));
      window.lastSearchParams = new URLSearchParams(params);
      // filterTypeë§Œ ì„œë²„ë¡œ ì „ì†¡
      // (fragmentTemplate, fragmentName, resultKey ë“±ì€ ë” ì´ìƒ ë„˜ê¸°ì§€ ì•ŠìŒ)
      const [searchResponse, countResponse] = await Promise.all([
        fetch('/search', {
          method: 'POST',
          body: params
        }),
        fetch('/count', {
          method: 'POST',
          body: params
        })
      ]);
      if (!searchResponse.ok) {
        throw new Error(`ê²€ìƒ‰ ìš”ì²­ ì‹¤íŒ¨: ${searchResponse.status}`);
      }
      if (!countResponse.ok) {
        throw new Error(`ì¹´ìš´íŠ¸ ìš”ì²­ ì‹¤íŒ¨: ${countResponse.status}`);
      }
      const [searchHtml, countJson] = await Promise.all([
        searchResponse.text(),
        countResponse.json()
      ]);
      if (countJson.error) {
        throw new Error(countJson.error);
      }
      const resultArea = document.getElementById("resultArea");
      if (resultArea) {
        resultArea.innerHTML = searchHtml;
      }
      const totalItems = countJson.totalItems;
      params.set("totalItems", totalItems);
      const paginationResponse = await fetch('/reBuildPagination', {
        method: 'POST',
        body: params
      });
      if (!paginationResponse.ok) {
        throw new Error(`í˜ì´ì§€ë„¤ì´ì…˜ ìš”ì²­ ì‹¤íŒ¨: ${paginationResponse.status}`);
      }
      const paginationHtml = await paginationResponse.text();
      const paginationArea = document.getElementById("paginationArea");
      if (paginationArea) {
        paginationArea.outerHTML = paginationHtml;
      }
    } catch (error) {
      console.error('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
      showError(`ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    } finally {
      setLoading(false);
    }
  }

  $form.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      event.preventDefault();
    }
  });

  $btn?.addEventListener("click", performSearch);
  
  document.getElementById("resetFiltersBtn")?.addEventListener("click", () => {
    const $form = document.getElementById("searchApiForm");
    if (!$form) return;
    const selects = $form.querySelectorAll("select.filter-select-box");
    selects.forEach(select => {
      select.selectedIndex = 0;
    });
    const textInputs = $form.querySelectorAll("input[type='text']");
    textInputs.forEach(input => input.value = '');
    const dateInputs = $form.querySelectorAll("input[type='date']");
    dateInputs.forEach(input => input.value = '');
    const currentPageInput = $form.querySelector("input[name='currentPage']");
    if (currentPageInput) currentPageInput.value = 1;
    $errorMessage.style.display = 'none';
  });

  // ì‹œì‘ì¼ ë³€ê²½ ì‹œ ì¢…ë£Œì¼ì˜ min ì†ì„± ë™ê¸°í™”
  const startDateInput = document.querySelector("input[name='startDate']");
  const endDateInput = document.querySelector("input[name='endDate']");

  if (startDateInput && endDateInput) {
    startDateInput.addEventListener('change', function() {
      if (startDateInput.value) {
        endDateInput.min = startDateInput.value;
        // ë§Œì•½ ì´ë¯¸ ì„ íƒëœ ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ì´ì „ì´ë©´ ì¢…ë£Œì¼ì„ ì‹œì‘ì¼ë¡œ ë§ì¶¤
        if (endDateInput.value && endDateInput.value < startDateInput.value) {
          endDateInput.value = startDateInput.value;
        }
      } else {
        endDateInput.min = '';
      }
    });
    // í˜ì´ì§€ ë¡œë”© ì‹œì—ë„ minê°’ ë™ê¸°í™”
    if (startDateInput.value) {
      endDateInput.min = startDateInput.value;
      if (endDateInput.value && endDateInput.value < startDateInput.value) {
        endDateInput.value = startDateInput.value;
      }
    }
  }

})();
</script>

<script th:inline="javascript">
// filterTypeì´ room_salesë©´ í˜ì´ì§€ ë¡œë”© í›„ /search 1íšŒ í˜¸ì¶œ
(function() {
  window.addEventListener('DOMContentLoaded', function() {
    const filterTypeInput = document.querySelector("input[name='filterType']");
    if (filterTypeInput && filterTypeInput.value === 'room_sales') {
      fetch('/search', {
        method: 'POST',
        body: new URLSearchParams({ filterType: 'room_sales' })
      })
      .then(res => res.text())
      .then(html => {
        const resultArea = document.getElementById('resultArea');
        if (resultArea) resultArea.innerHTML = html;
      });
    }
  });
})();
</script>


</div>
